<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tr·ª£ L√Ω C√¥ng Vi·ªác - Ultimate Edition</title>
    
    <!-- Meta tags for better performance -->
    <meta name="description" content="·ª®ng d·ª•ng AI nh·∫≠n di·ªán c·∫£m x√∫c v√† h·ªó tr·ª£ nƒÉng su·∫•t c√¥ng vi·ªác">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- Add favicon to prevent 404 -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://unpkg.com">
    
    <!-- Enhanced Face-API loading with comprehensive fallback -->
    <script>
        // Prevent Ethereum wallet extension conflicts
        window.originalDefineProperty = Object.defineProperty;
        Object.defineProperty = function(obj, prop, descriptor) {
            if (prop === 'ethereum' && window.ethereum) {
                console.warn('Prevented ethereum redefinition by extension');
                return obj;
            }
            return window.originalDefineProperty.call(this, obj, prop, descriptor);
        };

        // Enhanced face-api loading with multiple CDN fallback
        (function() {
            const scriptSources = [
                {
                    url: 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js',
                    name: 'JSDelivr CDN'
                },
                {
                    url: 'https://unpkg.com/@vladmandic/face-api@latest/dist/face-api.min.js',
                    name: 'UNPKG CDN'
                },
                {
                    url: 'https://cdn.skypack.dev/@vladmandic/face-api',
                    name: 'Skypack CDN'
                }
            ];
            
            let loadAttempt = 0;
            let faceApiLoaded = false;
            
            function updateLoadingStatus(message) {
                console.log(`Face-API Loading: ${message}`);
                const statusElement = document.getElementById('faceApiStatus');
                if (statusElement) {
                    statusElement.textContent = message;
                }
            }
            
            function loadScript(source) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = source.url;
                    script.defer = true;
                    script.async = false;
                    
                    const timeout = setTimeout(() => {
                        script.remove();
                        reject(new Error(`Timeout loading from ${source.name}`));
                    }, 15000); // 15 second timeout
                    
                    script.onload = () => {
                        clearTimeout(timeout);
                        console.log(`Face-API loaded successfully from ${source.name}`);
                        faceApiLoaded = true;
                        updateLoadingStatus(`Loaded from ${source.name} ‚úÖ`);
                        resolve();
                    };
                    
                    script.onerror = () => {
                        clearTimeout(timeout);
                        script.remove();
                        console.warn(`Failed to load Face-API from ${source.name}`);
                        reject(new Error(`Failed to load from ${source.name}`));
                    };
                    
                    document.head.appendChild(script);
                });
            }
            
            async function loadFaceAPI() {
                updateLoadingStatus('Initializing...');
                
                for (const source of scriptSources) {
                    try {
                        loadAttempt++;
                        updateLoadingStatus(`Trying ${source.name} (${loadAttempt}/${scriptSources.length})`);
                        
                        await loadScript(source);
                        return; // Success!
                        
                    } catch (error) {
                        console.warn(`Attempt ${loadAttempt} failed:`, error.message);
                        
                        if (loadAttempt < scriptSources.length) {
                            updateLoadingStatus(`Retrying... (${loadAttempt}/${scriptSources.length})`);
                            await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1s between attempts
                        }
                    }
                }
                
                // All attempts failed
                console.error('Failed to load Face-API from all CDN sources');
                updateLoadingStatus('‚ùå Failed to load AI library');
                
                document.addEventListener('DOMContentLoaded', () => {
                    const statusText = document.getElementById('statusText');
                    if (statusText) {
                        statusText.innerHTML = `
                            <div style="color: #e74c3c;">
                                ‚ùå Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán AI t·ª´ t·∫•t c·∫£ CDN.<br>
                                üîß H√£y th·ª≠:<br>
                                ‚Ä¢ Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng<br>
                                ‚Ä¢ ƒê·ªïi DNS v·ªÅ 8.8.8.8<br>
                                ‚Ä¢ S·ª≠ d·ª•ng VPN<br>
                                ‚Ä¢ T·∫£i l·∫°i trang (F5)
                            </div>
                        `;
                    }
                });
            }
            
            // Start loading
            loadFaceAPI();
        })();
        
        // Global error prevention
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('ethereum')) {
                console.warn('Suppressed ethereum extension error:', e.message);
                e.preventDefault();
                return false;
            }
        });
    </script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/productivity.css">
    
    <!-- Enhanced styles -->
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top: 3px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .loading-status {
            font-size: 14px;
            opacity: 0.8;
            text-align: center;
        }
        
        .system-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .error-details {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 10px 25px rgba(238, 90, 36, 0.3);
        }
        
        .camera-help {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 10px 25px rgba(245, 87, 108, 0.3);
        }
        
        .restart-btn {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 10px 5px;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
            animation: pulse 2s infinite;
        }
        
        .restart-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 35px rgba(255, 107, 107, 0.6);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .performance-monitor {
            position: fixed;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            z-index: 1000;
            min-width: 140px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        
        .performance-monitor div {
            margin: 3px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background: #2ecc71; }
        .status-warning { background: #f39c12; }
        .status-error { background: #e74c3c; }
        
        .troubleshooting {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 25px rgba(9, 132, 227, 0.3);
        }
        
        .troubleshooting h4 {
            margin-top: 0;
            color: #fff;
            font-size: 1.2em;
        }
        
        .troubleshooting ol {
            margin: 15px 0;
            padding-left: 25px;
        }
        
        .troubleshooting li {
            margin: 10px 0;
            line-height: 1.5;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .backend-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .backend-webgl {
            background: linear-gradient(45deg, #00b894, #00a085);
            color: white;
        }
        
        .backend-cpu {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
            color: white;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .feature-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
        }
        
        .tab-btn {
            position: relative;
            overflow: hidden;
        }
        
        .tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .tab-btn:hover::before {
            left: 100%;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">ü§ñ AI Assistant Ultimate</div>
        <div class="loading-status" id="faceApiStatus">Initializing...</div>
        <div style="margin-top: 20px; font-size: 12px; opacity: 0.7;">
            ƒêang t·∫£i th∆∞ vi·ªán AI t·ª´ CDN...
        </div>
    </div>

    <!-- System Performance Monitor -->
    <div id="performanceMonitor" class="performance-monitor" style="display: none;">
        <div><strong>üöÄ AI Engine</strong></div>
        <div>FPS: <span id="fpsValue">--</span></div>
        <div>Backend: <span id="backendValue">--</span></div>
        <div>Memory: <span id="memoryValue">--</span></div>
        <div>Status: <span class="status-indicator" id="statusIndicator"></span><span id="engineStatus">Starting</span></div>
    </div>

    <!-- Navigation Tabs -->
    <div class="tab-navigation">
        <button class="tab-btn active" data-tab="emotion">üé≠ Nh·∫≠n Di·ªán C·∫£m X√∫c</button>
        <button class="tab-btn" data-tab="productivity">üíº H·ªó Tr·ª£ C√¥ng Vi·ªác</button>
        <button class="tab-btn" data-tab="analytics">üìä Th·ªëng K√™</button>
        <button class="tab-btn" data-tab="assistant">ü§ñ AI Tr·ª£ L√Ω</button>
        <button class="tab-btn" data-tab="database">üíæ Database & API</button>
    </div>

    <!-- AI Chat Button (Floating) -->
    <button id="chatToggle" class="chat-toggle" onclick="toggleChat()">
        üí¨
    </button>

    <!-- AI Chat Panel -->
    <div id="chatPanel" class="chat-panel">
        <div class="chat-header">
            <h3>ü§ñ AI Assistant Ultimate</h3>
            <button onclick="toggleChat()" class="chat-close">‚úï</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message chat-message-bot">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="message-text">
                        Xin ch√†o! T√¥i l√† AI Assistant Ultimate - phi√™n b·∫£n ho√†n h·∫£o! üöÄ<br><br>
                        ‚úÖ Kh·∫Øc ph·ª•c ho√†n to√†n l·ªói WebGL/WASM<br>
                        ‚úÖ Fallback th√¥ng minh CPU/GPU<br>
                        ‚úÖ Multiple CDN v·ªõi auto-failover<br>
                        ‚úÖ Database & API mi·ªÖn ph√≠<br>
                        ‚úÖ Real-time analytics & insights<br>
                        ‚úÖ Smart productivity recommendations<br><br>
                        üéØ S·∫µn s√†ng h·ªó tr·ª£ b·∫°n 24/7!
                    </div>
                </div>
            </div>
        </div>
        <div class="chat-input-container">
            <input type="text" id="chatInput" placeholder="H·ªèi AI Assistant..." maxlength="500">
            <button id="chatSend" onclick="sendMessage()">üì§</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <header style="text-align: center; margin-bottom: 30px;">
            <h1 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 2.5em; margin: 20px 0;">
                ü§ñ AI Assistant Ultimate Edition
            </h1>
            <p style="font-size: 1.1em; color: #666; margin-bottom: 30px;">
                ·ª®ng d·ª•ng AI th√¥ng minh v·ªõi kh·∫£ nƒÉng kh·∫Øc ph·ª•c l·ªói t·ª± ƒë·ªông v√† t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t
            </p>
        </header>
        
        <!-- System Status -->
        <div id="systemStatus" class="system-info" style="display: none;">
            <h4>üîß Tr·∫°ng Th√°i H·ªá Th·ªëng</h4>
            <div id="systemDetails"></div>
        </div>

        <!-- Emotion Detection Tab -->
        <div id="emotionTab" class="tab-content active">
            <div class="feature-grid">
                <div class="feature-card">
                    <h3>üé≠ AI Emotion Engine</h3>
                    <div class="controls">
                        <button id="startBtn" class="btn btn-primary" disabled>
                            üé• B·∫Øt ƒê·∫ßu Ph√¢n T√≠ch
                        </button>
                        <button id="stopBtn" class="btn btn-secondary" disabled>
                            ‚èπÔ∏è D·ª´ng L·∫°i
                        </button>
                        <button id="systemCheckBtn" class="btn btn-info" onclick="runSystemCheck()">
                            üîç Ki·ªÉm Tra H·ªá Th·ªëng
                        </button>
                        <button id="restartEngineBtn" class="restart-btn" onclick="restartAIEngine()" style="display: none;">
                            üîÑ Kh·ªüi ƒê·ªông L·∫°i AI
                        </button>
                    </div>
                </div>
            </div>

            <div class="status" id="status">
                <div id="statusText">ƒêang kh·ªüi t·∫°o AI Engine...</div>
            </div>

            <div class="video-container">
                <video id="video" autoplay muted playsinline></video>
                <canvas id="overlay"></canvas>
                
                <!-- Enhanced emotion display -->
                <div class="emotion-display" id="emotionDisplay">
                    <div class="emotion-main">
                        <div class="emotion-emoji" id="emotionEmoji">üé≠</div>
                        <div class="emotion-info">
                            <div class="emotion-label" id="emotionLabel">Ch·ªù ph√¢n t√≠ch...</div>
                            <div class="emotion-confidence" id="emotionConfidence"></div>
                        </div>
                    </div>
                    <div class="emotion-message" id="emotionMessage">
                        H∆∞·ªõng camera v·ªÅ m·∫∑t b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu ph√¢n t√≠ch c·∫£m x√∫c!
                    </div>
                    <div class="productivity-suggestion" id="productivitySuggestion"></div>
                </div>
            </div>

            <!-- Enhanced Troubleshooting Guide -->
            <div id="troubleshooting" class="troubleshooting" style="display: none;">
                <h4>üõ†Ô∏è H∆∞·ªõng d·∫´n kh·∫Øc ph·ª•c l·ªói n√¢ng cao</h4>
                <ol>
                    <li><strong>L·ªói WebGL:</strong> App t·ª± ƒë·ªông chuy·ªÉn v·ªÅ CPU backend - kh√¥ng c·∫ßn lo l·∫Øng!</li>
                    <li><strong>WASM 404:</strong> Multiple CDN failover ƒë·∫£m b·∫£o t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán</li>
                    <li><strong>Camera blocked:</strong> C·∫•p quy·ªÅn camera trong c√†i ƒë·∫∑t tr√¨nh duy·ªát</li>
                    <li><strong>Extension conflicts:</strong> Disable crypto wallet extensions n·∫øu c·∫ßn</li>
                    <li><strong>Network issues:</strong> Th·ª≠ ƒë·ªïi DNS v·ªÅ 8.8.8.8 ho·∫∑c 1.1.1.1</li>
                    <li><strong>Performance:</strong> ƒê√≥ng c√°c tab kh√°c v√† restart browser</li>
                </ol>
                <div style="margin-top: 20px;">
                    <button class="restart-btn" onclick="window.location.reload()">üîÑ T·∫£i L·∫°i Trang</button>
                    <button class="restart-btn" onclick="clearAllCache()">üóëÔ∏è X√≥a Cache</button>
                    <button class="restart-btn" onclick="runFullDiagnostic()">üîç Ch·∫©n ƒêo√°n ƒê·∫ßy ƒê·ªß</button>
                </div>
            </div>
        </div>

        <!-- Other tabs content (same as before but optimized) -->
        <div id="productivityTab" class="tab-content">
            <!-- Productivity content will be loaded here -->
            <h2>üíº H·ªó Tr·ª£ C√¥ng Vi·ªác Th√¥ng Minh</h2>
            <div id="productivityContent">Loading...</div>
        </div>

        <div id="analyticsTab" class="tab-content">
            <!-- Analytics content will be loaded here -->
            <h2>üìä Th·ªëng K√™ & B√°o C√°o</h2>
            <div id="analyticsContent">Loading...</div>
        </div>

        <div id="assistantTab" class="tab-content">
            <!-- AI Assistant content will be loaded here -->
            <h2>ü§ñ AI Tr·ª£ L√Ω Th√¥ng Minh</h2>
            <div id="assistantContent">Loading...</div>
        </div>

        <div id="databaseTab" class="tab-content">
            <!-- Database content will be loaded here -->
            <h2>üíæ Database & API</h2>
            <div id="databaseContent">Loading...</div>
        </div>
    </div>

    <!-- Enhanced JavaScript with error prevention -->
    <script>
        // Comprehensive error prevention and system optimization
        (function() {
            'use strict';
            
            // Prevent duplicate variable declarations
            if (window.AI_ASSISTANT_INITIALIZED) {
                console.warn('AI Assistant already initialized, skipping...');
                return;
            }
            window.AI_ASSISTANT_INITIALIZED = true;
            
            // Global namespace for app
            window.AIAssistant = {
                initialized: false,
                backend: null,
                performance: {
                    startTime: Date.now(),
                    fps: 0,
                    memory: 0
                }
            };
            
            // Enhanced system requirements checker
            function checkSystemRequirements() {
                const results = {
                    webgl: false,
                    webgl2: false,
                    getUserMedia: false,
                    wasm: false,
                    indexedDB: false,
                    localStorage: false,
                    serviceWorker: false,
                    canvas: false
                };
                
                try {
                    // Check WebGL
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    const gl2 = canvas.getContext('webgl2');
                    results.webgl = !!gl;
                    results.webgl2 = !!gl2;
                    results.canvas = !!canvas.getContext('2d');
                } catch (e) {
                    console.warn('WebGL check failed:', e);
                }
                
                // Check getUserMedia
                results.getUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
                
                // Check WebAssembly
                results.wasm = typeof WebAssembly === 'object' && typeof WebAssembly.instantiate === 'function';
                
                // Check IndexedDB
                results.indexedDB = 'indexedDB' in window && !!window.indexedDB;
                
                // Check localStorage
                try {
                    localStorage.setItem('__test__', '__test__');
                    localStorage.removeItem('__test__');
                    results.localStorage = true;
                } catch (e) {}
                
                // Check Service Worker
                results.serviceWorker = 'serviceWorker' in navigator;
                
                return results;
            }
            
            // Update system status display
            function updateSystemStatus(requirements) {
                const systemStatus = document.getElementById('systemStatus');
                const systemDetails = document.getElementById('systemDetails');
                
                if (!systemDetails) return;
                
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">';
                
                const featureNames = {
                    webgl: 'üéÆ WebGL (GPU)',
                    webgl2: 'üöÄ WebGL 2.0',
                    getUserMedia: 'üìπ Camera API',
                    wasm: '‚ö° WebAssembly',
                    indexedDB: 'üóÑÔ∏è IndexedDB',
                    localStorage: 'üíæ LocalStorage',
                    serviceWorker: 'üîß Service Worker',
                    canvas: 'üé® Canvas 2D'
                };
                
                Object.entries(requirements).forEach(([feature, supported]) => {
                    const icon = supported ? '‚úÖ' : '‚ùå';
                    const status = supported ? 'H·ªó tr·ª£' : 'Kh√¥ng h·ªó tr·ª£';
                    const statusClass = supported ? 'status-success' : 'status-error';
                    
                    html += `
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span>${featureNames[feature] || feature}</span>
                                <span class="status-indicator ${statusClass}"></span>
                            </div>
                            <small style="opacity: 0.8;">${status}</small>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // Add browser info
                html += `
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                        <h5>üåê Th√¥ng tin tr√¨nh duy·ªát:</h5>
                        <div style="font-family: monospace; font-size: 12px; line-height: 1.4;">
                            <div><strong>User Agent:</strong> ${navigator.userAgent}</div>
                            <div><strong>Platform:</strong> ${navigator.platform}</div>
                            <div><strong>Language:</strong> ${navigator.language}</div>
                            <div><strong>Online:</strong> ${navigator.onLine ? '‚úÖ Connected' : '‚ùå Offline'}</div>
                            <div><strong>Memory:</strong> ${navigator.deviceMemory || 'Unknown'} GB</div>
                            <div><strong>Cores:</strong> ${navigator.hardwareConcurrency || 'Unknown'}</div>
                        </div>
                    </div>
                `;
                
                systemDetails.innerHTML = html;
                systemStatus.style.display = 'block';
            }
            
            // Global system check function
            window.runSystemCheck = function() {
                const requirements = checkSystemRequirements();
                updateSystemStatus(requirements);
                
                // Show troubleshooting if issues found
                if (!requirements.webgl || !requirements.getUserMedia) {
                    document.getElementById('troubleshooting').style.display = 'block';
                }
                
                return requirements;
            };
            
            // Enhanced error handlers
            window.clearAllCache = function() {
                try {
                    // Clear localStorage
                    localStorage.clear();
                    
                    // Clear sessionStorage  
                    sessionStorage.clear();
                    
                    // Clear IndexedDB (if supported)
                    if ('indexedDB' in window) {
                        indexedDB.deleteDatabase('AIAssistantDB');
                    }
                    
                    alert('Cache ƒë√£ ƒë∆∞·ª£c x√≥a! Trang s·∫Ω t·∫£i l·∫°i...');
                    window.location.reload();
                } catch (e) {
                    console.error('Error clearing cache:', e);
                    alert('Kh√¥ng th·ªÉ x√≥a cache. Vui l√≤ng th·ª≠ t·∫£i l·∫°i trang th·ªß c√¥ng.');
                }
            };
            
            window.runFullDiagnostic = function() {
                console.group('üîç AI Assistant Full Diagnostic');
                
                // System requirements
                const requirements = checkSystemRequirements();
                console.log('System Requirements:', requirements);
                
                // Performance info
                if (window.performance) {
                    console.log('Performance:', {
                        memory: window.performance.memory,
                        timing: window.performance.timing,
                        navigation: window.performance.navigation
                    });
                }
                
                // Face-API status
                console.log('Face-API:', {
                    loaded: typeof faceapi !== 'undefined',
                    tf: typeof faceapi !== 'undefined' && faceapi.tf ? 'Available' : 'Not available'
                });
                
                // WebGL info
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl');
                    if (gl) {
                        console.log('WebGL Info:', {
                            vendor: gl.getParameter(gl.VENDOR),
                            renderer: gl.getParameter(gl.RENDERER),
                            version: gl.getParameter(gl.VERSION),
                            shadingLanguageVersion: gl.getParameter(gl.SHADING_LANGUAGE_VERSION),
                            maxTextureSize: gl.getParameter(gl.MAX_TEXTURE_SIZE)
                        });
                    }
                } catch (e) {
                    console.log('WebGL Info: Not available');
                }
                
                console.groupEnd();
                
                // Show results
                runSystemCheck();
            };
            
            window.restartAIEngine = function() {
                if (window.emotionApp && typeof window.emotionApp.restart === 'function') {
                    window.emotionApp.restart();
                } else {
                    window.location.reload();
                }
            };
            
            // Initialize performance monitor
            function initPerformanceMonitor() {
                const monitor = document.getElementById('performanceMonitor');
                const fpsValue = document.getElementById('fpsValue');
                const backendValue = document.getElementById('backendValue');
                const memoryValue = document.getElementById('memoryValue');
                const statusIndicator = document.getElementById('statusIndicator');
                const engineStatus = document.getElementById('engineStatus');
                
                let frameCount = 0;
                let lastTime = Date.now();
                
                function updateMonitor() {
                    frameCount++;
                    const now = Date.now();
                    
                    if (now - lastTime >= 1000) {
                        const fps = Math.round(frameCount * 1000 / (now - lastTime));
                        if (fpsValue) fpsValue.textContent = fps;
                        
                        // Memory info
                        if (window.performance && window.performance.memory && memoryValue) {
                            const memory = Math.round(window.performance.memory.usedJSHeapSize / 1024 / 1024);
                            memoryValue.textContent = `${memory}MB`;
                        }
                        
                        // Backend info
                        if (window.AIAssistant.backend && backendValue) {
                            backendValue.innerHTML = `<span class="backend-badge backend-${window.AIAssistant.backend}">${window.AIAssistant.backend.toUpperCase()}</span>`;
                        }
                        
                        // Status indicator
                        if (statusIndicator && engineStatus) {
                            if (window.AIAssistant.initialized) {
                                statusIndicator.className = 'status-indicator status-success';
                                engineStatus.textContent = 'Ready';
                            } else {
                                statusIndicator.className = 'status-indicator status-warning';
                                engineStatus.textContent = 'Loading';
                            }
                        }
                        
                        frameCount = 0;
                        lastTime = now;
                    }
                    
                    requestAnimationFrame(updateMonitor);
                }
                
                updateMonitor();
            }
            
            // Hide loading overlay when ready
            function hideLoadingOverlay() {
                const overlay = document.getElementById('loadingOverlay');
                const monitor = document.getElementById('performanceMonitor');
                
                if (overlay) {
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        if (monitor) monitor.style.display = 'block';
                    }, 500);
                }
            }
            
            // Initialize when DOM is ready
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üöÄ AI Assistant Ultimate initializing...');
                
                // Run initial system check
                const requirements = checkSystemRequirements();
                console.log('System Check Results:', requirements);
                
                // Initialize performance monitor
                initPerformanceMonitor();
                
                // Hide loading overlay after 3 seconds or when face-api loads
                setTimeout(hideLoadingOverlay, 3000);
                
                // Check if face-api loaded
                const checkFaceAPI = setInterval(() => {
                    if (typeof faceapi !== 'undefined') {
                        clearInterval(checkFaceAPI);
                        hideLoadingOverlay();
                        console.log('‚úÖ Face-API loaded successfully');
                    }
                }, 500);
            });
            
            // Enhanced error handling
            window.addEventListener('error', function(e) {
                if (e.message && (e.message.includes('ethereum') || e.message.includes('evmAsk'))) {
                    console.warn('Suppressed wallet extension error:', e.message);
                    e.preventDefault();
                    return false;
                }
                
                console.error('Global Error:', {
                    message: e.message,
                    filename: e.filename,
                    lineno: e.lineno,
                    colno: e.colno,
                    error: e.error
                });
            });
            
            window.addEventListener('unhandledrejection', function(e) {
                console.error('Unhandled Promise Rejection:', e.reason);
                e.preventDefault();
            });
            
        })();
        
        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Mark button as active
            const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }
        }
        
        // Add event listeners for tabs
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        });
        
        // Chat functionality placeholder
        function toggleChat() {
            const chatPanel = document.getElementById('chatPanel');
            if (chatPanel) {
                chatPanel.classList.toggle('active');
            }
        }
        
        function sendMessage() {
            const input = document.getElementById('chatInput');
            if (input && input.value.trim()) {
                console.log('Chat message:', input.value);
                // Add chat functionality here
                input.value = '';
            }
        }
    </script>
    
    <!-- Load enhanced modules -->
    <script src="js/config-enhanced.js"></script>
    <script src="js/camera-enhanced.js"></script>
    <script src="js/emotions-ultimate.js"></script>
    <script src="js/productivity-ultimate.js"></script>
    <script src="js/ai-assistant-ultimate.js"></script>
    
    <!-- Load main application -->
    <script src="js/app-ultimate.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tr·ª£ L√Ω C√¥ng Vi·ªác - Emotion Detection (Fixed)</title>
    
    <!-- Add favicon to prevent 404 error -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    
    <!-- Prevent extension conflicts -->
    <script>
        // Prevent Ethereum wallet extension conflicts
        (function() {
            const originalDefineProperty = Object.defineProperty;
            Object.defineProperty = function(obj, prop, descriptor) {
                if (prop === 'ethereum' && window.ethereum) {
                    console.warn('Prevented ethereum redefinition by extension');
                    return obj;
                }
                return originalDefineProperty.call(this, obj, prop, descriptor);
            };
            
            // Global error handler for extension conflicts
            window.addEventListener('error', function(e) {
                if (e.message && (
                    e.message.includes('ethereum') || 
                    e.message.includes('evmAsk') ||
                    e.message.includes('Cannot redefine property')
                )) {
                    console.warn('üõ°Ô∏è Suppressed extension conflict:', e.message);
                    e.preventDefault();
                    return false;
                }
            });
        })();
    </script>
    
    <!-- Face-api.js Library with enhanced fallback and preload optimization -->
    <script>
        (function() {
            // Multiple CDN sources for better reliability
            const scripts = [
                'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js',
                'https://unpkg.com/@vladmandic/face-api@latest/dist/face-api.min.js',
                'https://cdn.skypack.dev/@vladmandic/face-api'
            ];
            
            let scriptLoaded = false;
            let loadStartTime = Date.now();
            
            // Preload models paths
            window.MODEL_PATHS = {
                tinyFaceDetector: './models/tiny_face_detector_model-weights_manifest.json',
                faceExpressionNet: './models/face_expression_model-weights_manifest.json'
            };
            
            async function loadFaceAPI() {
                console.log('ü§ñ Starting Face-API loading process...');
                
                for (const url of scripts) {
                    try {
                        console.log(`üîÑ Attempting to load Face-API from: ${url}`);
                        
                        await new Promise((resolve, reject) => {
                            const script = document.createElement('script');
                            script.src = url;
                            script.defer = true;
                            script.crossOrigin = 'anonymous';
                            
                            script.onload = () => {
                                const loadTime = Date.now() - loadStartTime;
                                console.log(`‚úÖ Face-API loaded successfully from: ${url} (${loadTime}ms)`);
                                scriptLoaded = true;
                                
                                // Verify Face-API is available
                                if (typeof faceapi !== 'undefined') {
                                    console.log('‚úÖ Face-API object is available globally');
                                    window.faceApiLoaded = true;
                                } else {
                                    console.warn('‚ö†Ô∏è Face-API loaded but not available globally');
                                }
                                
                                resolve();
                            };
                            
                            script.onerror = (error) => {
                                console.warn(`‚ùå Failed to load from: ${url}`, error);
                                reject(new Error(`Failed to load from ${url}`));
                            };
                            
                            // Timeout after 15 seconds
                            setTimeout(() => {
                                if (!scriptLoaded) {
                                    console.warn(`‚è∞ Timeout loading from: ${url}`);
                                    reject(new Error(`Timeout loading from ${url}`));
                                }
                            }, 15000);
                            
                            document.head.appendChild(script);
                        });
                        break; // Success, stop trying
                    } catch (e) {
                        console.warn(`‚ùå Error loading from ${url}:`, e.message);
                        continue; // Try next CDN
                    }
                }
                
                if (!scriptLoaded) {
                    console.error('‚ùå CRITICAL: Could not load Face-API from any CDN');
                    window.faceApiLoadError = true;
                    
                    // Show user-friendly error
                    const statusEl = document.getElementById('status');
                    if (statusEl) {
                        statusEl.innerHTML = `
                            <div style="color: red; text-align: center; padding: 20px;">
                                ‚ö†Ô∏è <strong>Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán Face-API</strong><br>
                                <small>Ki·ªÉm tra k·∫øt n·ªëi internet v√† th·ª≠ l·∫°i</small><br>
                                <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px;">üîÑ Th·ª≠ l·∫°i</button>
                            </div>
                        `;
                    }
                }
            }
            
            loadFaceAPI();
        })();
    </script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/productivity.css">
    
    <!-- Additional CSS for camera fixes -->
    <style>
        .debug-panel {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 14px;
        }
        
        .debug-content {
            background: #fff;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .controls button {
            margin: 5px;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        
        .controls button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .controls button:hover:not(:disabled) {
            background: #0056b3;
        }
        
        #cameraStatus.stat-value {
            font-weight: bold;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <!-- Navigation Tabs -->
    <div class="tab-navigation">
        <button class="tab-btn active" data-tab="emotion">üé≠ Nh·∫≠n Di·ªán C·∫£m X√∫c</button>
        <button class="tab-btn" data-tab="productivity">üíº H·ªó Tr·ª£ C√¥ng Vi·ªác</button>
        <button class="tab-btn" data-tab="analytics">üìä Th·ªëng K√™</button>
        <button class="tab-btn" data-tab="assistant">ü§ñ AI Tr·ª£ L√Ω</button>
    </div>

    <!-- AI Chat Button (Floating) -->
    <button id="chatToggle" class="chat-toggle" onclick="toggleChat()">
        üí¨
    </button>

    <!-- AI Chat Panel -->
    <div id="chatPanel" class="chat-panel">
        <div class="chat-header">
            <h3>ü§ñ AI Tr·ª£ L√Ω Th√¥ng Minh</h3>
            <button onclick="toggleChat()" class="chat-close">‚úï</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message chat-message-bot">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="message-text">
                        Xin ch√†o! T√¥i l√† AI Assistant. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:<br><br>
                        ‚úÖ Theo d√µi nƒÉng su·∫•t l√†m vi·ªác<br>
                        ‚úÖ Ph√°t hi·ªán cƒÉng th·∫≥ng, m·ªát m·ªèi<br>
                        ‚úÖ ƒê·ªÅ xu·∫•t ngh·ªâ ng∆°i th√¥ng minh<br>
                        ‚úÖ B√°o c√°o & th·ªëng k√™<br>
                        ‚úÖ ƒêi·ªÅu khi·ªÉn Pomodoro<br><br>
                        H√£y h·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨!
                    </div>
                </div>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="if(event.key==='Enter') sendMessage()" />
            <button onclick="sendMessage()" class="btn-send">üì§</button>
            <button onclick="toggleVoice()" id="voiceBtn" class="btn-voice">üé§</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <header>
            <h1 id="mainTitle">üé≠ AI Tr·ª£ L√Ω C√¥ng Vi·ªác</h1>
            <p class="subtitle">Nh·∫≠n di·ªán c·∫£m x√∫c & h·ªó tr·ª£ nƒÉng su·∫•t l√†m vi·ªác v·ªõi AI</p>
        </header>

        <!-- Loading Status -->
        <div id="status" class="status">
            <span id="statusText">ƒêang t·∫£i m√¥ h√¨nh AI...</span>
            <div class="loader"></div>
        </div>

        <!-- Video & Canvas Container -->
        <div class="video-container">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="canvas"></canvas>
        </div>

        <!-- Control Buttons -->
        <div class="controls">
            <button id="setupBtn">
                <span class="btn-icon">üìπ</span>
                <span class="btn-text">Thi·∫øt l·∫≠p Camera</span>
            </button>
            <button id="startBtn" disabled>
                <span class="btn-icon">‚ñ∂Ô∏è</span>
                <span class="btn-text">B·∫Øt ƒê·∫ßu</span>
            </button>
            <button id="stopBtn" disabled>
                <span class="btn-icon">‚èπÔ∏è</span>
                <span class="btn-text">D·ª´ng L·∫°i</span>
            </button>
            <button id="debugBtn">
                <span class="btn-icon">üîç</span>
                <span class="btn-text">Debug</span>
            </button>
        </div>

        <!-- Emotion Display -->
        <div id="emotionDisplay" class="emotion-display">
            <div id="emotionEmoji" class="emotion-emoji">ü§ñ</div>
            <div id="emotionText" class="emotion-text">ƒêang ch·ªù...</div>
            <div id="emotionMessage" class="emotion-message">Nh·∫•n "B·∫Øt ƒê·∫ßu" ƒë·ªÉ nh·∫≠n di·ªán c·∫£m x√∫c</div>
        </div>

        <!-- Statistics -->
        <div id="stats" class="stats">
            <div class="stat-item">
                <span class="stat-label">FPS:</span>
                <span id="fps" class="stat-value">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ƒê·ªô ch√≠nh x√°c:</span>
                <span id="confidence" class="stat-value">0%</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Camera:</span>
                <span id="cameraStatus" class="stat-value">Ch∆∞a thi·∫øt l·∫≠p</span>
            </div>
        </div>
        
        <!-- Debug Info Panel (Hidden by default) -->
        <div id="debugPanel" class="debug-panel" style="display: none;">
            <h3>üîç Th√¥ng tin Debug</h3>
            <div id="debugContent" class="debug-content"></div>
        </div>

        <!-- ============================================
             PRODUCTIVITY TAB - H·ªñ TR·ª¢ C√îNG VI·ªÜC
        ============================================ -->
        <div id="productivityTab" class="tab-content" style="display: none;">
            <!-- Tr·∫°ng th√°i l√†m vi·ªác -->
            <div id="workState" class="section-card">
                <h2>üìä Tr·∫°ng Th√°i L√†m Vi·ªác</h2>
                <p class="hint">ƒêang ph√¢n t√≠ch tr·∫°ng th√°i c·ªßa b·∫°n...</p>
            </div>

            <!-- Pomodoro Timer -->
            <div class="section-card">
                <h2>üçÖ Pomodoro Timer</h2>
                <div id="pomodoroTimer">
                    <p class="hint">Timer s·∫Ω xu·∫•t hi·ªán khi b·∫°n b·∫Øt ƒë·∫ßu nh·∫≠n di·ªán</p>
                </div>
            </div>

            <!-- Ghi ch√∫ c√¥ng vi·ªác -->
            <div class="section-card">
                <h2>üìù Ghi Ch√∫ C√¥ng Vi·ªác</h2>
                <div class="note-input-group">
                    <input type="text" id="noteInput" placeholder="Th√™m ghi ch√∫ v·ªÅ c√¥ng vi·ªác..." />
                    <button onclick="addNote()" class="btn-primary">‚ûï Th√™m</button>
                </div>
                <div id="workNotes" class="work-notes-container">
                    <p class="no-notes">Ch∆∞a c√≥ ghi ch√∫ n√†o. Th√™m ghi ch√∫ ƒë·∫ßu ti√™n!</p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="section-card">
                <h2>‚ö° H√†nh ƒê·ªông Nhanh</h2>
                <div class="quick-actions">
                    <button onclick="if(window.productivityTracker) window.productivityTracker.exportData()" class="action-btn">
                        üíæ Xu·∫•t b√°o c√°o
                    </button>
                    <button onclick="if(window.productivityTracker && confirm('X√≥a t·∫•t c·∫£ d·ªØ li·ªáu?')) window.productivityTracker.resetData()" class="action-btn danger">
                        üóëÔ∏è X√≥a d·ªØ li·ªáu
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================
             ANALYTICS TAB - TH·ªêNG K√ä
        ============================================ -->
        <div id="analyticsTab" class="tab-content" style="display: none;">
            <!-- Th·ªëng k√™ t·ªïng quan -->
            <div class="section-card">
                <h2>üìà Th·ªëng K√™ NƒÉng Su·∫•t</h2>
                <div id="productivityStats">
                    <p class="hint">Th·ªëng k√™ s·∫Ω xu·∫•t hi·ªán khi b·∫°n b·∫Øt ƒë·∫ßu l√†m vi·ªác</p>
                </div>
            </div>

            <!-- Bi·ªÉu ƒë·ªì c·∫£m x√∫c -->
            <div class="section-card">
                <h2>üé≠ Ph√¢n B·ªë C·∫£m X√∫c</h2>
                <div id="emotionChart" class="emotion-chart">
                    <p class="hint">Bi·ªÉu ƒë·ªì s·∫Ω xu·∫•t hi·ªán sau khi thu th·∫≠p d·ªØ li·ªáu</p>
                </div>
            </div>

            <!-- L·ªãch s·ª≠ c·∫£m x√∫c -->
            <div class="section-card">
                <h2>üìä L·ªãch S·ª≠ C·∫£m X√∫c</h2>
                <div id="emotionTimeline" class="emotion-timeline">
                    <p class="hint">Timeline s·∫Ω hi·ªÉn th·ªã l·ªãch s·ª≠ c·∫£m x√∫c c·ªßa b·∫°n</p>
                </div>
            </div>

            <!-- Tips & Recommendations -->
            <div class="section-card">
                <h2>üí° G·ª£i √ù C·∫£i Thi·ªán</h2>
                <div id="recommendations" class="recommendations">
                    <div class="tip-card">
                        <div class="tip-icon">üéØ</div>
                        <div class="tip-text">H√£y duy tr√¨ tr·∫°ng th√°i t·∫≠p trung b·∫±ng k·ªπ thu·∫≠t Pomodoro</div>
                    </div>
                    <div class="tip-card">
                        <div class="tip-icon">‚òï</div>
                        <div class="tip-text">Ngh·ªâ ng∆°i 5-10 ph√∫t sau m·ªói 25 ph√∫t l√†m vi·ªác</div>
                    </div>
                    <div class="tip-card">
                        <div class="tip-icon">üòå</div>
                        <div class="tip-text">Th·ª±c hi·ªán b√†i t·∫≠p th·ªü s√¢u khi c·∫£m th·∫•y cƒÉng th·∫≥ng</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================
             AI ASSISTANT TAB - TR·ª¢ L√ù ·∫¢O
        ============================================ -->
        <div id="assistantTab" class="tab-content" style="display: none;">
            <!-- Ch·∫ø ƒë·ªô t·ª± ƒë·ªông -->
            <div class="section-card">
                <h2>‚öôÔ∏è C√†i ƒê·∫∑t T·ª± ƒê·ªông</h2>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label class="switch">
                            <input type="checkbox" id="autoModeToggle" onchange="toggleAutoMode()" checked>
                            <span class="slider"></span>
                        </label>
                        <div class="setting-label">
                            <strong>ü§ñ Ch·∫ø ƒë·ªô t·ª± ƒë·ªông</strong>
                            <p>T·ª± ƒë·ªông ph√°t hi·ªán v√† c·∫£nh b√°o</p>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <label class="switch">
                            <input type="checkbox" id="alertsToggle" checked>
                            <span class="slider"></span>
                        </label>
                        <div class="setting-label">
                            <strong>üîî C·∫£nh b√°o</strong>
                            <p>Nh·∫≠n c·∫£nh b√°o v·ªÅ s·ª©c kh·ªèe</p>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <label class="switch">
                            <input type="checkbox" id="suggestionsToggle" checked>
                            <span class="slider"></span>
                        </label>
                        <div class="setting-label">
                            <strong>üí° G·ª£i √Ω</strong>
                            <p>Nh·∫≠n g·ª£i √Ω th√¥ng minh</p>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <label class="switch">
                            <input type="checkbox" id="voiceToggle">
                            <span class="slider"></span>
                        </label>
                        <div class="setting-label">
                            <strong>üîä Gi·ªçng n√≥i</strong>
                            <p>ƒê·ªçc c·∫£nh b√°o b·∫±ng gi·ªçng</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ng∆∞·ª°ng c·∫£nh b√°o -->
            <div class="section-card">
                <h2>‚ö†Ô∏è Ng∆∞·ª°ng C·∫£nh B√°o</h2>
                <div class="threshold-settings">
                    <div class="threshold-item">
                        <label>CƒÉng th·∫≥ng li√™n t·ª•c (l·∫ßn):</label>
                        <input type="number" id="stressThreshold" value="3" min="1" max="10" />
                    </div>
                    <div class="threshold-item">
                        <label>M·ªát m·ªèi li√™n t·ª•c (l·∫ßn):</label>
                        <input type="number" id="tiredThreshold" value="5" min="1" max="10" />
                    </div>
                    <div class="threshold-item">
                        <label>ƒêi·ªÉm t·∫≠p trung t·ªëi thi·ªÉu:</label>
                        <input type="number" id="focusThreshold" value="40" min="0" max="100" />
                    </div>
                    <div class="threshold-item">
                        <label>Kh√¥ng ph√°t hi·ªán khu√¥n m·∫∑t (l·∫ßn):</label>
                        <input type="number" id="absenceThreshold" value="10" min="1" max="20" />
                    </div>
                </div>
                <button onclick="updateThresholds()" class="btn-primary">üíæ L∆∞u c√†i ƒë·∫∑t</button>
            </div>

            <!-- L·ªãch s·ª≠ c·∫£nh b√°o -->
            <div class="section-card">
                <h2>üìú L·ªãch S·ª≠ C·∫£nh B√°o</h2>
                <div id="alertHistory" class="alert-history">
                    <p class="hint">L·ªãch s·ª≠ c·∫£nh b√°o s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</p>
                </div>
            </div>

            <!-- K·ªãch b·∫£n s·ª≠ d·ª•ng -->
            <div class="section-card">
                <h2>üéØ K·ªãch B·∫£n S·ª≠ D·ª•ng</h2>
                <div class="use-cases">
                    <div class="use-case-card">
                        <div class="use-case-icon">üìö</div>
                        <h3>H·ªçc sinh / Sinh vi√™n</h3>
                        <ul>
                            <li>‚úÖ Theo d√µi th·ªùi gian h·ªçc t·∫≠p</li>
                            <li>‚úÖ Ph√°t hi·ªán m·∫•t t·∫≠p trung</li>
                            <li>‚úÖ Ch·ªëng gian l·∫≠n thi online</li>
                            <li>‚úÖ Nh·∫Øc ngh·ªâ ng∆°i khi cƒÉng th·∫≥ng</li>
                        </ul>
                    </div>
                    
                    <div class="use-case-card">
                        <div class="use-case-icon">üíº</div>
                        <h3>Nh√¢n vi√™n Remote</h3>
                        <ul>
                            <li>‚úÖ T√≠nh gi·ªù l√†m vi·ªác ch√≠nh x√°c</li>
                            <li>‚úÖ B√°o c√°o nƒÉng su·∫•t cho qu·∫£n l√Ω</li>
                            <li>‚úÖ Ph√°t hi·ªán v·∫Øng m·∫∑t</li>
                            <li>‚úÖ Theo d√µi hi·ªáu su·∫•t</li>
                        </ul>
                    </div>
                    
                    <div class="use-case-card">
                        <div class="use-case-icon">üßë‚Äçüíº</div>
                        <h3>Freelancer</h3>
                        <ul>
                            <li>‚úÖ Theo d√µi th·ªùi gian d·ª± √°n</li>
                            <li>‚úÖ T·ªëi ∆∞u nƒÉng su·∫•t</li>
                            <li>‚úÖ Qu·∫£n l√Ω nhi·ªÅu task</li>
                            <li>‚úÖ Xu·∫•t b√°o c√°o cho kh√°ch h√†ng</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Audio Elements -->
    <audio id="happySound" loop></audio>
    <audio id="sadSound" loop></audio>
    <audio id="calmSound" loop></audio>

    <!-- JavaScript Files with error handling -->
    <script>
        // Prevent duplicate variable declarations globally
        window.EmotionApp = window.EmotionApp || {};
        
        // Enhanced error handling
        window.addEventListener('error', function(e) {
            const suppressedErrors = [
                'WebGL is not supported',
                'WebGL context could not be created', 
                'WASM loading failed',
                'Cannot redefine property'
            ];
            
            if (suppressedErrors.some(err => e.message && e.message.includes(err))) {
                console.warn('üõ°Ô∏è Suppressed error:', e.message);
                e.preventDefault();
                return false;
            }
        });
    </script>
    
    <!-- Camera Fix Script -->
    <script>
        // Camera Management Class for fixing camera issues
        class CameraManager {
            constructor() {
                console.log('üé• Kh·ªüi t·∫°o Camera Manager...');
                this.stream = null;
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas ? this.canvas.getContext('2d') : null;
                this.isSetup = false;
                
                this.setupBtn = document.getElementById('setupBtn');
                this.debugBtn = document.getElementById('debugBtn');
                
                if (this.setupBtn) {
                    this.setupBtn.addEventListener('click', () => this.setupCamera());
                }
                
                if (this.debugBtn) {
                    this.debugBtn.addEventListener('click', () => this.showDebugInfo());
                }
            }
            
            async setupCamera() {
                try {
                    console.log('üìπ B·∫Øt ƒë·∫ßu thi·∫øt l·∫≠p camera...');
                    
                    // Update status
                    const statusText = document.getElementById('statusText');
                    if (statusText) {
                        statusText.textContent = 'üìπ ƒêang truy c·∫≠p camera...';
                    }
                    
                    // Stop existing stream
                    if (this.stream) {
                        console.log('üõë D·ª´ng stream c≈©...');
                        this.stream.getTracks().forEach(track => {
                            console.log(`Stopping ${track.kind} track`);
                            track.stop();
                        });
                        this.stream = null;
                    }
                    
                    // Check camera support
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ camera API');
                    }
                    
                    console.log('üîç Y√™u c·∫ßu quy·ªÅn camera...');
                    
                    // Camera constraints
                    const constraints = {
                        video: {
                            width: { ideal: 640, max: 1280 },
                            height: { ideal: 480, max: 720 },
                            facingMode: 'user'
                        },
                        audio: false
                    };
                    
                    // Get camera stream
                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    console.log('‚úÖ ƒê√£ c√≥ quy·ªÅn camera');
                    
                    // Set video source
                    if (this.video) {
                        this.video.srcObject = this.stream;
                        
                        // Wait for video metadata
                        await new Promise((resolve, reject) => {
                            const timeout = setTimeout(() => {
                                reject(new Error('Video loading timeout'));
                            }, 10000);
                            
                            this.video.onloadedmetadata = () => {
                                clearTimeout(timeout);
                                console.log(`Video k√≠ch th∆∞·ªõc: ${this.video.videoWidth}x${this.video.videoHeight}`);
                                
                                // Set canvas size
                                if (this.canvas) {
                                    this.canvas.width = this.video.videoWidth;
                                    this.canvas.height = this.video.videoHeight;
                                }
                                
                                // Play video
                                this.video.play().then(() => {
                                    console.log('‚úÖ Video ƒëang ph√°t');
                                    resolve();
                                }).catch(reject);
                            };
                            
                            this.video.onerror = (e) => {
                                clearTimeout(timeout);
                                reject(new Error('Video loading error'));
                            };
                        });
                    }
                    
                    this.isSetup = true;
                    
                    // Update UI
                    if (statusText) {
                        statusText.textContent = '‚úÖ Camera s·∫µn s√†ng!';
                    }
                    
                    // Update camera status
                    const cameraStatus = document.getElementById('cameraStatus');
                    if (cameraStatus) {
                        cameraStatus.textContent = '‚úÖ S·∫µn s√†ng';
                        cameraStatus.style.color = '#28a745';
                    }
                    
                    // Enable start button
                    const startBtn = document.getElementById('startBtn');
                    if (startBtn) {
                        startBtn.disabled = false;
                    }
                    
                    // Update emotion display
                    const emotionText = document.getElementById('emotionText');
                    const emotionMessage = document.getElementById('emotionMessage');
                    if (emotionText) emotionText.textContent = 'Camera s·∫µn s√†ng';
                    if (emotionMessage) emotionMessage.textContent = 'Nh·∫•n "B·∫Øt ƒê·∫ßu" ƒë·ªÉ nh·∫≠n di·ªán c·∫£m x√∫c';
                    
                    if (this.setupBtn) {
                        this.setupBtn.innerHTML = '<span class="btn-icon">üîÑ</span><span class="btn-text">Thi·∫øt l·∫≠p l·∫°i</span>';
                    }
                    
                    console.log('‚úÖ Camera setup ho√†n t·∫•t!');
                    
                } catch (error) {
                    console.error('‚ùå L·ªói camera:', error);
                    
                    // Update status
                    const statusText = document.getElementById('statusText');
                    if (statusText) {
                        statusText.textContent = '‚ùå L·ªói camera: ' + error.message;
                    }
                    
                    // Update camera status
                    const cameraStatus = document.getElementById('cameraStatus');
                    if (cameraStatus) {
                        cameraStatus.textContent = '‚ùå L·ªói';
                        cameraStatus.style.color = '#dc3545';
                    }
                    
                    // Update emotion display
                    const emotionEmoji = document.getElementById('emotionEmoji');
                    const emotionText = document.getElementById('emotionText');
                    const emotionMessage = document.getElementById('emotionMessage');
                    
                    if (emotionEmoji) emotionEmoji.textContent = 'üìπ';
                    if (emotionText) emotionText.textContent = 'L·ªói camera';
                    
                    // Specific error messages
                    let errorMsg = error.message;
                    if (error.name === 'NotAllowedError') {
                        errorMsg = 'Vui l√≤ng cho ph√©p truy c·∫≠p camera';
                    } else if (error.name === 'NotFoundError') {
                        errorMsg = 'Kh√¥ng t√¨m th·∫•y camera';
                    } else if (error.name === 'NotReadableError') {
                        errorMsg = 'Camera ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi ·ª©ng d·ª•ng kh√°c';
                    }
                    
                    if (emotionMessage) emotionMessage.textContent = errorMsg;
                    
                    // Show alert with instructions
                    alert(`‚ùå L·ªói camera: ${errorMsg}\n\nüí° H∆∞·ªõng d·∫´n kh·∫Øc ph·ª•c:\n‚Ä¢ Cho ph√©p truy c·∫≠p camera khi tr√¨nh duy·ªát h·ªèi\n‚Ä¢ Ki·ªÉm tra camera c√≥ ƒë∆∞·ª£c k·∫øt n·ªëi kh√¥ng\n‚Ä¢ ƒê√≥ng c√°c ·ª©ng d·ª•ng kh√°c ƒëang s·ª≠ d·ª•ng camera\n‚Ä¢ Th·ª≠ t·∫£i l·∫°i trang`);
                }
            }
            
            showDebugInfo() {
                const info = [
                    'üîç CAMERA DEBUG INFO:',
                    '====================',
                    '',
                    'üì± Browser Support:',
                    `- MediaDevices: ${navigator.mediaDevices ? '‚úÖ' : '‚ùå'}`,
                    `- getUserMedia: ${navigator.mediaDevices?.getUserMedia ? '‚úÖ' : '‚ùå'}`,
                    `- Online: ${navigator.onLine ? '‚úÖ' : '‚ùå'}`,
                    '',
                    'üé• Camera Status:',
                    `- Stream active: ${this.stream ? '‚úÖ' : '‚ùå'}`,
                    `- Setup complete: ${this.isSetup ? '‚úÖ' : '‚ùå'}`,
                    '',
                    'üì∫ Video Element:',
                    `- Video width: ${this.video?.videoWidth || 'N/A'}`,
                    `- Video height: ${this.video?.videoHeight || 'N/A'}`,
                    `- Ready state: ${this.video?.readyState || 'N/A'}`,
                    `- Paused: ${this.video?.paused ? '‚ùå' : '‚úÖ'}`,
                    '',
                    'üé® Canvas Element:',
                    `- Canvas width: ${this.canvas?.width || 'N/A'}`,
                    `- Canvas height: ${this.canvas?.height || 'N/A'}`,
                    `- Context: ${this.ctx ? '‚úÖ' : '‚ùå'}`,
                    '',
                    'üîß Actions:',
                    '‚Ä¢ Nh·∫•n "Thi·∫øt l·∫≠p Camera" ƒë·ªÉ kh·ªüi ƒë·ªông l·∫°i',
                    '‚Ä¢ Ki·ªÉm tra Console (F12) ƒë·ªÉ xem log chi ti·∫øt',
                    '‚Ä¢ Th·ª≠ tr√¨nh duy·ªát kh√°c n·∫øu c·∫ßn'
                ].join('\n');
                
                alert(info);
                
                // Log to console
                console.group('üé• CAMERA DEBUG');
                console.log('Stream:', this.stream);
                console.log('Setup:', this.isSetup);
                console.log('Video element:', this.video);
                console.log('Canvas element:', this.canvas);
                console.log('MediaDevices support:', !!navigator.mediaDevices);
                console.groupEnd();
            }
            
            // Method to get current status
            getStatus() {
                return {
                    hasStream: !!this.stream,
                    isSetup: this.isSetup,
                    videoReady: this.video && this.video.readyState >= 2,
                    canvasReady: !!this.canvas && !!this.ctx
                };
            }
        }
        
        // Initialize Camera Manager
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîß Initializing Camera Manager...');
            window.cameraManager = new CameraManager();
        });
    </script>
    
    <script src="js/config.js"></script>
    <script src="js/emotions.js"></script>
    <script src="js/camera.js"></script>
    
    <!-- Productivity with duplicate prevention -->
    <script>
        if (typeof window.productivityTracker === 'undefined') {
            window.productivityTrackerLoaded = false;
        } else {
            window.productivityTrackerLoaded = true;
            console.warn('üõ°Ô∏è ProductivityTracker already exists, skipping duplicate load');
        }
    </script>
    <script src="js/productivity.js"></script>
    
    <script src="js/ai-assistant.js"></script>
    
    <!-- Enhanced app.js with backend fallback -->
    <script>
        (function() {
            // Load original app.js and enhance it
            const script = document.createElement('script');
            script.src = 'js/app.js';
            script.async = false;
            
            script.onload = function() {
                console.log('‚úÖ App.js loaded, adding backend fallback...');
                
                // Override initApp with smart backend detection
                if (typeof window.initApp === 'function') {
                    const originalInitApp = window.initApp;
                    
                    window.initApp = async function() {
                        try {
                            // Check if Face-API is available
                            if (typeof faceapi === 'undefined') {
                                throw new Error('Face-API library not loaded - check network connection');
                            }
                            
                            console.log('üöÄ Starting enhanced app with intelligent backend selection...');
                            
                            // Enhanced backend detection and fallback
                            const backends = [
                                { name: 'webgl', priority: 1, description: 'GPU accelerated (fastest)' },
                                { name: 'wasm', priority: 2, description: 'WebAssembly (balanced)' },
                                { name: 'cpu', priority: 3, description: 'CPU only (slowest but most compatible)' }
                            ];
                            
                            let success = false;
                            let selectedBackend = null;
                            
                            for (const backend of backends) {
                                try {
                                    console.log(`üîÑ Testing ${backend.name.toUpperCase()} backend (${backend.description})...`);
                                    
                                    // Set backend with timeout
                                    const backendPromise = Promise.all([
                                        faceapi.tf.setBackend(backend.name),
                                        faceapi.tf.ready()
                                    ]);
                                    
                                    const timeoutPromise = new Promise((_, reject) => 
                                        setTimeout(() => reject(new Error('Backend initialization timeout')), 10000)
                                    );
                                    
                                    await Promise.race([backendPromise, timeoutPromise]);
                                    
                                    // Verify backend is working
                                    const backendInfo = faceapi.tf.getBackend();
                                    console.log(`‚úÖ ${backend.name.toUpperCase()} backend initialized successfully:`, backendInfo);
                                    
                                    // Test model loading with progress
                                    console.log('üì¶ Loading AI models...');
                                    const modelLoadStart = Date.now();
                                    
                                    // Load models with timeout and retry
                                    const modelPromises = [
                                        faceapi.nets.tinyFaceDetector.loadFromUri('./models'),
                                        faceapi.nets.faceExpressionNet.loadFromUri('./models')
                                    ];
                                    
                                    const modelTimeoutPromise = new Promise((_, reject) => 
                                        setTimeout(() => reject(new Error('Model loading timeout after 30 seconds')), 30000)
                                    );
                                    
                                    await Promise.race([Promise.all(modelPromises), modelTimeoutPromise]);
                                    
                                    const modelLoadTime = Date.now() - modelLoadStart;
                                    console.log(`‚úÖ Models loaded successfully in ${modelLoadTime}ms`);
                                    
                                    // Test model functionality
                                    console.log('üß™ Testing model functionality...');
                                    if (faceapi.nets.tinyFaceDetector.isLoaded && faceapi.nets.faceExpressionNet.isLoaded) {
                                        console.log('‚úÖ All models verified and ready');
                                        success = true;
                                        selectedBackend = backend;
                                        break;
                                    } else {
                                        throw new Error('Models loaded but not properly initialized');
                                    }
                                    
                                } catch (error) {
                                    console.warn(`‚ùå ${backend.name.toUpperCase()} backend failed:`, error.message);
                                    
                                    // Clean up failed backend
                                    try {
                                        await faceapi.tf.disposeVariables();
                                    } catch (cleanupError) {
                                        console.warn('‚ö†Ô∏è Cleanup error:', cleanupError.message);
                                    }
                                    
                                    continue; // Try next backend
                                }
                            }
                            
                            if (!success) {
                                throw new Error('All TensorFlow backends failed to initialize - check models folder and network connection');
                            }
                            
                            // Save successful configuration
                            window.currentBackend = selectedBackend;
                            localStorage.setItem('preferredBackend', selectedBackend.name);
                            
                            console.log(`üéâ System ready with ${selectedBackend.name.toUpperCase()} backend!`);
                            
                            // Call original initialization
                            return originalInitApp();
                            
                        } catch (error) {
                            console.error('‚ùå Enhanced app initialization failed:', error);
                            
                            // Enhanced error handling with diagnostics
                            const statusElement = document.getElementById('status');
                            if (statusElement) {
                                let errorDetails = '';
                                let suggestions = '';
                                
                                if (error.message.includes('Face-API')) {
                                    errorDetails = 'Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán Face-API';
                                    suggestions = '‚Ä¢ Ki·ªÉm tra k·∫øt n·ªëi internet<br>‚Ä¢ Th·ª≠ t·∫£i l·∫°i trang<br>‚Ä¢ Ki·ªÉm tra t∆∞·ªùng l·ª≠a/proxy';
                                } else if (error.message.includes('models')) {
                                    errorDetails = 'Kh√¥ng th·ªÉ t·∫£i AI models';
                                    suggestions = '‚Ä¢ Ki·ªÉm tra th∆∞ m·ª•c /models<br>‚Ä¢ ƒê·∫£m b·∫£o c√≥ file .json v√† binary<br>‚Ä¢ Th·ª≠ ch·∫°y t·ª´ HTTP server';
                                } else if (error.message.includes('backend')) {
                                    errorDetails = 'Kh√¥ng th·ªÉ kh·ªüi t·∫°o TensorFlow backend';
                                    suggestions = '‚Ä¢ Th·ª≠ tr√¨nh duy·ªát kh√°c<br>‚Ä¢ Ki·ªÉm tra WebGL support<br>‚Ä¢ C·∫≠p nh·∫≠t browser';
                                } else if (error.message.includes('timeout')) {
                                    errorDetails = 'Qu√° th·ªùi gian t·∫£i (ch·∫≠m m·∫°ng)';
                                    suggestions = '‚Ä¢ Th·ª≠ l·∫°i khi m·∫°ng ·ªïn ƒë·ªãnh<br>‚Ä¢ ƒê·ª£i th√™m √≠t ph√∫t<br>‚Ä¢ Ki·ªÉm tra t·ªëc ƒë·ªô m·∫°ng';
                                } else {
                                    errorDetails = 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
                                    suggestions = '‚Ä¢ M·ªü Developer Tools (F12)<br>‚Ä¢ Ki·ªÉm tra Console logs<br>‚Ä¢ Th·ª≠ tr√¨nh duy·ªát kh√°c';
                                }
                                
                                statusElement.innerHTML = `
                                    <div style="background: #fee; border: 2px solid #fcc; border-radius: 8px; padding: 20px; margin: 20px; text-align: center;">
                                        <div style="font-size: 48px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                                        <h3 style="color: #c00; margin: 10px 0;">Kh√¥ng th·ªÉ kh·ªüi t·∫°o ·ª©ng d·ª•ng</h3>
                                        <div style="color: #800; margin: 10px 0;"><strong>${errorDetails}</strong></div>
                                        <div style="color: #600; font-size: 12px; margin: 10px 0;">
                                            Chi ti·∫øt: <code>${error.message}</code>
                                        </div>
                                        <div style="text-align: left; margin: 15px 0; padding: 10px; background: #ffd; border-left: 4px solid #fa0;">
                                            <strong>üí° G·ª£i √Ω kh·∫Øc ph·ª•c:</strong><br>
                                            ${suggestions}
                                        </div>
                                        <div style="margin-top: 15px;">
                                            <button onclick="location.reload()" style="margin: 5px; padding: 10px 20px; background: #007cba; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                                üîÑ T·∫£i l·∫°i trang
                                            </button>
                                            <button onclick="openDiagnostic()" style="margin: 5px; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                                ÔøΩ Ch·∫©n ƒëo√°n
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            // Log detailed error for debugging
                            console.group('üîç Error Diagnostics');
                            console.error('Error message:', error.message);
                            console.error('Error stack:', error.stack);
                            console.log('Face-API available:', typeof faceapi !== 'undefined');
                            console.log('TensorFlow available:', typeof tf !== 'undefined');
                            console.log('Browser:', navigator.userAgent);
                            console.log('Online:', navigator.onLine);
                            console.groupEnd();
                            
                            throw error;
                        }
                    };
                }
            };
            
            script.onerror = function() {
                console.error('‚ùå Failed to load app.js');
            };
            
            document.head.appendChild(script);
        })();
    </script>
    
    <!-- Initialize Global Objects -->
    <script>
        // Kh·ªüi t·∫°o ProductivityTracker v√† AIAssistant sau khi t·∫•t c·∫£ scripts loaded
        // Check if already declared to prevent duplicates
        // S·ª≠ d·ª•ng window.aiAssistant, kh√¥ng khai b√°o l·∫°i
        
        // Ch·ªù window load ho√†n to√†n
        window.addEventListener('load', () => {
            console.log('üîß Page loaded, initializing systems...');
            
            // ƒê·ª£i th√™m 500ms ƒë·ªÉ ƒë·∫£m b·∫£o t·∫•t c·∫£ scripts ƒë√£ parse xong
            setTimeout(() => {
                try {
                    console.log('üîç Checking ProductivityTracker instance...');
                    
                    // S·ª≠ d·ª•ng ProductivityTracker instance ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o t·ª´ productivity.js
                    if (typeof window.productivityTracker !== 'undefined' && window.productivityTracker !== null) {
                        console.log('‚úÖ ProductivityTracker instance found from productivity.js!');
                        console.log('   Methods available:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.productivityTracker)).slice(0, 5).join(', '));
                    } else {
                        console.error('‚ùå ProductivityTracker instance not found! Check js/productivity.js initialization');
                        alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y ProductivityTracker instance. Ki·ªÉm tra file js/productivity.js');
                        return;
                    }
                    
                    console.log('üîç Checking AIAssistant class...');
                    
                    // Kh·ªüi t·∫°o AIAssistant
                    if (typeof AIAssistant !== 'undefined' && window.productivityTracker) {
                        console.log('‚úÖ AIAssistant class found, creating instance...');
                        window.aiAssistant = new AIAssistant(window.productivityTracker);
                        console.log('‚úÖ AIAssistant initialized successfully!');
                        console.log('   Auto mode enabled:', window.aiAssistant.autoMode.enabled);
                    } else {
                        console.error('‚ùå AIAssistant class not found or ProductivityTracker not ready! Check js/ai-assistant.js and js/productivity.js');
                        alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y AIAssistant class ho·∫∑c ProductivityTracker ch∆∞a s·∫µn s√†ng. Ki·ªÉm tra file js/ai-assistant.js v√† js/productivity.js');
                        return;
                    }
                    
                    console.log('üé® Updating UI...');
                    
                    // C·∫≠p nh·∫≠t UI ban ƒë·∫ßu
                    if (window.productivityTracker) {
                        try {
                            updateProductivityUI();
                            console.log('‚úÖ Productivity UI updated');
                        } catch (err) {
                            console.error('‚ùå Error updating Productivity UI:', err);
                        }
                        
                        try {
                            updateAnalytics();
                            console.log('‚úÖ Analytics updated');
                        } catch (err) {
                            console.error('‚ùå Error updating Analytics:', err);
                        }
                    }
                    
                    console.log('üéâ All systems initialized successfully!');
                    console.log('‚úÖ You can now use:');
                    console.log('   - window.productivityTracker');
                    console.log('   - window.aiAssistant');
                    
                    // Update status UI to show ready state
                    const statusElement = document.getElementById('status');
                    if (statusElement) {
                        statusElement.innerHTML = `
                            <div style="color: green; text-align: center; padding: 10px;">
                                ‚úÖ <strong>H·ªá th·ªëng ƒë√£ s·∫µn s√†ng!</strong><br>
                                <small>Nh·∫•n "B·∫Øt ƒê·∫ßu" ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫≠n di·ªán c·∫£m x√∫c</small>
                            </div>
                        `;
                    }
                    
                    // Enable start button
                    const startBtn = document.getElementById('startBtn');
                    if (startBtn) {
                        startBtn.disabled = false;
                        startBtn.style.opacity = '1';
                    }
                    
                } catch (error) {
                    console.error('‚ùå CRITICAL ERROR initializing systems:', error);
                    console.error('Error stack:', error.stack);
                    alert('‚ùå L·ªói nghi√™m tr·ªçng khi kh·ªüi t·∫°o: ' + error.message + '\n\nXem Console (F12) ƒë·ªÉ bi·∫øt chi ti·∫øt.');
                }
            }, 500);
        });
        
        // Update UI functions
        function updateProductivityUI() {
            if (!window.productivityTracker) return;
            
            // Update Pomodoro display
            const pomodoroTimer = document.getElementById('pomodoroTimer');
            if (pomodoroTimer) {
                pomodoroTimer.innerHTML = `
                    <div class="pomodoro-display">
                        <div class="timer-circle">
                            <div class="timer-time" id="timerDisplay">25:00</div>
                            <div class="timer-label" id="timerLabel">S·∫µn s√†ng</div>
                        </div>
                        <div class="timer-controls">
                            <button onclick="startPomodoro()" class="btn-pomodoro btn-start">
                                ‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu
                            </button>
                            <button onclick="pausePomodoro()" class="btn-pomodoro btn-pause" disabled>
                                ‚è∏Ô∏è T·∫°m d·ª´ng
                            </button>
                            <button onclick="resetPomodoro()" class="btn-pomodoro btn-reset">
                                üîÑ ƒê·∫∑t l·∫°i
                            </button>
                        </div>
                        <div class="pomodoro-stats">
                            <div class="stat">
                                <span class="stat-value" id="pomodoroCount">0</span>
                                <span class="stat-label">Phi√™n ho√†n th√†nh</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Update work notes
            updateWorkNotes();
            
            // Update productivity stats
            const statsDiv = document.getElementById('productivityStats');
            if (statsDiv && window.productivityTracker) {
                const stats = window.productivityTracker.getCurrentStats();
                statsDiv.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">‚è∞</div>
                            <div class="stat-content">
                                <div class="stat-value">${formatTime(stats.totalWorkTime)}</div>
                                <div class="stat-label">T·ªïng th·ªùi gian l√†m vi·ªác</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üòä</div>
                            <div class="stat-content">
                                <div class="stat-value">${formatTime(stats.focusedTime)}</div>
                                <div class="stat-label">Th·ªùi gian t·∫≠p trung</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üòî</div>
                            <div class="stat-content">
                                <div class="stat-value">${formatTime(stats.distractedTime)}</div>
                                <div class="stat-label">Th·ªùi gian m·∫•t t·∫≠p trung</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üéØ</div>
                            <div class="stat-content">
                                <div class="stat-value">${Math.round(window.productivityTracker.focusScore)}</div>
                                <div class="stat-label">ƒêi·ªÉm t·∫≠p trung</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hrs > 0) {
                return `${hrs}g ${mins}p`;
            } else if (mins > 0) {
                return `${mins}p ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }
        
        // Pomodoro functions with error handling
        function startPomodoro() {
            console.log('üçÖ startPomodoro() called');
            if (!window.productivityTracker) {
                console.error('‚ùå ProductivityTracker not initialized!');
                alert('‚ùå L·ªói: H·ªá th·ªëng ch∆∞a s·∫µn s√†ng. H√£y reload trang.');
                return;
            }
            
            try {
                window.productivityTracker.startPomodoro();
                updatePomodoroButtons(true, false, false);
                console.log('‚úÖ Pomodoro started');
            } catch (error) {
                console.error('‚ùå Error starting Pomodoro:', error);
                alert('‚ùå L·ªói khi b·∫Øt ƒë·∫ßu Pomodoro: ' + error.message);
            }
        }
        
        function pausePomodoro() {
            console.log('‚è∏Ô∏è pausePomodoro() called');
            if (!window.productivityTracker) {
                console.error('‚ùå ProductivityTracker not initialized!');
                return;
            }
            
            try {
                window.productivityTracker.pausePomodoro();
                updatePomodoroButtons(false, true, false);
                console.log('‚úÖ Pomodoro paused');
            } catch (error) {
                console.error('‚ùå Error pausing Pomodoro:', error);
                alert('‚ùå L·ªói khi t·∫°m d·ª´ng Pomodoro: ' + error.message);
            }
        }
        
        function resetPomodoro() {
            console.log('üîÑ resetPomodoro() called');
            if (!window.productivityTracker) {
                console.error('‚ùå ProductivityTracker not initialized!');
                return;
            }
            
            try {
                window.productivityTracker.resetPomodoro();
                updatePomodoroButtons(false, false, false);
                console.log('‚úÖ Pomodoro reset');
            } catch (error) {
                console.error('‚ùå Error resetting Pomodoro:', error);
                alert('‚ùå L·ªói khi reset Pomodoro: ' + error.message);
            }
        }
        
        function updatePomodoroButtons(startDisabled, pauseDisabled, resetDisabled) {
            const startBtn = document.querySelector('.btn-start');
            const pauseBtn = document.querySelector('.btn-pause');
            const resetBtn = document.querySelector('.btn-reset');
            
            if (startBtn) startBtn.disabled = startDisabled;
            if (pauseBtn) pauseBtn.disabled = pauseDisabled;
            if (resetBtn) resetBtn.disabled = resetDisabled;
        }
        
        // Work notes functions with error handling
        function addNote() {
            console.log('üìù addNote() called');
            const input = document.getElementById('noteInput');
            
            if (!input) {
                console.error('‚ùå Note input element not found!');
                return;
            }
            
            const note = input.value.trim();
            
            if (!note) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p n·ªôi dung ghi ch√∫!');
                return;
            }
            
            if (!window.productivityTracker) {
                console.error('‚ùå ProductivityTracker not initialized!');
                alert('‚ùå L·ªói: H·ªá th·ªëng ch∆∞a s·∫µn s√†ng. H√£y reload trang.');
                return;
            }
            
            try {
                window.productivityTracker.addWorkNote(note);
                input.value = '';
                updateWorkNotes();
                console.log('‚úÖ Note added:', note);
            } catch (error) {
                console.error('‚ùå Error adding note:', error);
                alert('‚ùå L·ªói khi th√™m ghi ch√∫: ' + error.message);
            }
        }
        
        function updateWorkNotes() {
            if (!window.productivityTracker) return;
            
            const container = document.getElementById('workNotes');
            const notes = window.productivityTracker.workNotes || [];
            
            if (notes.length === 0) {
                container.innerHTML = '<p class="no-notes">Ch∆∞a c√≥ ghi ch√∫ n√†o. Th√™m ghi ch√∫ ƒë·∫ßu ti√™n!</p>';
                return;
            }
            
            const notesHTML = notes.map((note, index) => `
                <div class="note-item">
                    <div class="note-content">
                        <div class="note-text">${note.note}</div>
                        <div class="note-time">${new Date(note.timestamp).toLocaleString('vi-VN')}</div>
                    </div>
                    <button onclick="deleteNote(${index})" class="note-delete">üóëÔ∏è</button>
                </div>
            `).join('');
            
            container.innerHTML = notesHTML;
        }
        
        function deleteNote(index) {
            if (window.productivityTracker) {
                window.productivityTracker.workNotes.splice(index, 1);
                window.productivityTracker.saveData();
                updateWorkNotes();
            }
        }
    </script>
    
    <!-- Chat & Assistant Functions -->
    <script>
        function toggleChat() {
            const chatPanel = document.getElementById('chatPanel');
            const chatToggle = document.getElementById('chatToggle');
            
            if (chatPanel.classList.contains('show')) {
                chatPanel.classList.remove('show');
                chatToggle.style.display = 'flex';
            } else {
                chatPanel.classList.add('show');
                chatToggle.style.display = 'none';
            }
        }
        
        function sendMessage() {
            console.log('üí¨ sendMessage() called');
            const input = document.getElementById('chatInput');
            
            if (!input) {
                console.error('‚ùå Chat input element not found!');
                return;
            }
            
            const message = input.value.trim();
            
            if (!message) {
                console.log('‚ö†Ô∏è Empty message, ignoring');
                return;
            }
            
            if (!window.aiAssistant) {
                console.error('‚ùå AIAssistant not initialized!');
                alert('‚ùå L·ªói: AI Assistant ch∆∞a s·∫µn s√†ng. H√£y reload trang.');
                return;
            }
            
            try {
                console.log('üì§ Sending message:', message);
                window.aiAssistant.processMessage(message);
                input.value = '';
                console.log('‚úÖ Message sent');
            } catch (error) {
                console.error('‚ùå Error sending message:', error);
                alert('‚ùå L·ªói khi g·ª≠i tin nh·∫Øn: ' + error.message);
            }
        }
        
        function toggleVoice() {
            console.log('üé§ toggleVoice() called');
            
            if (!window.aiAssistant) {
                console.error('‚ùå AIAssistant not initialized!');
                alert('‚ùå L·ªói: AI Assistant ch∆∞a s·∫µn s√†ng.');
                return;
            }
            
            try {
                if (window.aiAssistant.isListening) {
                    window.aiAssistant.stopListening();
                    console.log('‚úÖ Voice stopped');
                } else {
                    window.aiAssistant.startListening();
                    console.log('‚úÖ Voice started');
                }
            } catch (error) {
                console.error('‚ùå Error toggling voice:', error);
                alert('‚ùå L·ªói khi b·∫≠t/t·∫Øt gi·ªçng n√≥i: ' + error.message);
            }
        }
        
        function toggleAutoMode() {
            console.log('ü§ñ toggleAutoMode() called');
            
            if (!window.aiAssistant) {
                console.error('‚ùå AIAssistant not initialized!');
                return;
            }
            
            try {
                window.aiAssistant.toggleAutoMode();
                console.log('‚úÖ Auto mode toggled:', window.aiAssistant.autoMode.enabled);
            } catch (error) {
                console.error('‚ùå Error toggling auto mode:', error);
            }
        }
        
        function updateThresholds() {
            if (window.aiAssistant) {
                const thresholds = {
                    stressLevel: parseInt(document.getElementById('stressThreshold').value),
                    tirednessLevel: parseInt(document.getElementById('tiredThreshold').value),
                    focusDropLevel: parseInt(document.getElementById('focusThreshold').value),
                    noFaceDetected: parseInt(document.getElementById('absenceThreshold').value)
                };
                
                window.aiAssistant.thresholds = thresholds;
                window.aiAssistant.saveSettings();
                
                alert('‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t!');
            }
        }
    </script>
    
    <!-- Tab Switching Script -->
    <script>
        // Tab Navigation
        document.addEventListener('DOMContentLoaded', () => {
            const tabBtns = document.querySelectorAll('.tab-btn');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        });
        
        function switchTab(tabName) {
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Hide all tab contents
            const emotionContent = document.querySelector('.video-container').parentElement;
            document.getElementById('productivityTab').style.display = 'none';
            document.getElementById('analyticsTab').style.display = 'none';
            document.getElementById('assistantTab').style.display = 'none';
            
            // Show emotion detection elements
            const emotionElements = [
                '.video-container', '.controls', '#emotionDisplay', '#stats'
            ];
            
            // Show selected tab
            if (tabName === 'emotion') {
                emotionElements.forEach(selector => {
                    const el = document.querySelector(selector);
                    if (el) el.style.display = '';
                });
            } else if (tabName === 'productivity') {
                emotionElements.forEach(selector => {
                    const el = document.querySelector(selector);
                    if (el) el.style.display = 'none';
                });
                document.getElementById('productivityTab').style.display = 'block';
            } else if (tabName === 'analytics') {
                emotionElements.forEach(selector => {
                    const el = document.querySelector(selector);
                    if (el) el.style.display = 'none';
                });
                document.getElementById('analyticsTab').style.display = 'block';
                updateAnalytics();
            } else if (tabName === 'assistant') {
                emotionElements.forEach(selector => {
                    const el = document.querySelector(selector);
                    if (el) el.style.display = 'none';
                });
                document.getElementById('assistantTab').style.display = 'block';
                loadAlertHistory();
            }
        }
        
        function loadAlertHistory() {
            const historyContainer = document.getElementById('alertHistory');
            const logs = JSON.parse(localStorage.getItem('alertLogs') || '[]');
            
            if (logs.length === 0) {
                historyContainer.innerHTML = '<p class="hint">Ch∆∞a c√≥ c·∫£nh b√°o n√†o</p>';
                return;
            }
            
            const historyHTML = logs.slice(0, 20).map(log => {
                const date = new Date(log.timestamp);
                const priorityClass = `priority-${log.priority}`;
                
                return `
                    <div class="history-item ${priorityClass}">
                        <div class="history-time">${date.toLocaleString('vi-VN')}</div>
                        <div class="history-title">${log.title}</div>
                        <div class="history-message">${log.message}</div>
                    </div>
                `;
            }).join('');
            
            historyContainer.innerHTML = historyHTML;
        }
        
        // addNote() function is defined above in "Initialize Global Objects" script
        // Removed duplicate to avoid "already declared" error
        
        function updateAnalytics() {
            if (!window.productivityTracker) return;
            
            // Update stats
            window.productivityTracker.updateStatsDisplay();
            
            // Update emotion chart
            const chartData = window.productivityTracker.generateEmotionChart();
            const chartContainer = document.getElementById('emotionChart');
            
            if (chartData.length > 0) {
                const chartHTML = chartData.map(item => `
                    <div class="chart-bar">
                        <div class="chart-label">${window.productivityTracker.getEmotionEmoji(item.emotion)} ${item.emotion}</div>
                        <div class="chart-bar-bg">
                            <div class="chart-bar-fill" style="width: ${item.percentage}%"></div>
                        </div>
                        <div class="chart-value">${item.percentage}%</div>
                    </div>
                `).join('');
                
                chartContainer.innerHTML = chartHTML;
            }
            
            // Update timeline
            updateEmotionTimeline();
        }
        
        function updateEmotionTimeline() {
            if (!window.productivityTracker) return;
            
            const timeline = document.getElementById('emotionTimeline');
            const history = window.productivityTracker.emotionHistory.slice(-10).reverse();
            
            if (history.length === 0) {
                timeline.innerHTML = '<p class="hint">Ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch s·ª≠</p>';
                return;
            }
            
            const timelineHTML = history.map(item => {
                const date = new Date(item.timestamp);
                const emoji = window.productivityTracker.getEmotionEmoji(item.emotion);
                
                return `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <span class="timeline-emoji">${emoji}</span>
                            <span class="timeline-emotion">${item.emotion}</span>
                            <span class="timeline-score">T·∫≠p trung: ${item.focusScore}/100</span>
                            <span class="timeline-time">${date.toLocaleTimeString('vi-VN')}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            timeline.innerHTML = timelineHTML;
        }
        
        // Diagnostic function for troubleshooting
        function openDiagnostic() {
            alert('üîç Ch·∫©n ƒëo√°n h·ªá th·ªëng:\n\n' +
                  'ÔøΩ Face-API: ' + (typeof faceapi !== 'undefined' ? '‚úÖ OK' : '‚ùå L·ªói') + '\n' +
                  'ü§ñ ProductivityTracker: ' + (typeof window.productivityTracker !== 'undefined' ? '‚úÖ OK' : '‚ùå L·ªói') + '\n' +
                  'üß† AIAssistant: ' + (typeof window.aiAssistant !== 'undefined' ? '‚úÖ OK' : '‚ùå L·ªói') + '\n' +
                  'ÔøΩ M·∫°ng: ' + (navigator.onLine ? '‚úÖ Online' : '‚ùå Offline') + '\n\n' +
                  'Ki·ªÉm tra Console (F12) ƒë·ªÉ xem chi ti·∫øt!');
        }
        
        // Allow Enter key to add note
        document.addEventListener('DOMContentLoaded', () => {
            const noteInput = document.getElementById('noteInput');
            if (noteInput) {
                noteInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addNote();
                    }
                });
            }
        });
    </script>
</body>
</html>
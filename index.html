<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trợ Lý Công Việc - Emotion Detection (Fixed)</title>
    
    <!-- Add favicon to prevent 404 error -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🤖</text></svg>">
    
    <!-- Prevent extension conflicts -->
    <script>
        // Prevent Ethereum wallet extension conflicts
        (function() {
            const originalDefineProperty = Object.defineProperty;
            Object.defineProperty = function(obj, prop, descriptor) {
                if (prop === 'ethereum' && window.ethereum) {
                    console.warn('Prevented ethereum redefinition by extension');
                    return obj;
                }
                return originalDefineProperty.call(this, obj, prop, descriptor);
            };
            
            // Global error handler for extension conflicts
            window.addEventListener('error', function(e) {
                if (e.message && (
                    e.message.includes('ethereum') || 
                    e.message.includes('evmAsk') ||
                    e.message.includes('Cannot redefine property')
                )) {
                    console.warn('🛡️ Suppressed extension conflict:', e.message);
                    e.preventDefault();
                    return false;
                }
            });
        })();
    </script>
    
    <!-- Face-api.js Library with fallback -->
    <script>
        (function() {
            const scripts = [
                'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js',
                'https://unpkg.com/@vladmandic/face-api@latest/dist/face-api.min.js'
            ];
            
            let scriptLoaded = false;
            
            async function loadFaceAPI() {
                for (const url of scripts) {
                    try {
                        await new Promise((resolve, reject) => {
                            const script = document.createElement('script');
                            script.src = url;
                            script.defer = true;
                            script.onload = () => {
                                console.log('✅ Face-API loaded from:', url);
                                scriptLoaded = true;
                                resolve();
                            };
                            script.onerror = () => {
                                console.warn('❌ Failed to load from:', url);
                                reject();
                            };
                            document.head.appendChild(script);
                        });
                        break; // Success, stop trying
                    } catch (e) {
                        console.warn('Retrying with next CDN...');
                    }
                }
                
                if (!scriptLoaded) {
                    console.error('❌ Could not load Face-API from any CDN');
                }
            }
            
            loadFaceAPI();
        })();
    </script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/productivity.css">
</head>
<body>
    <!-- Navigation Tabs -->
    <div class="tab-navigation">
        <button class="tab-btn active" data-tab="emotion">🎭 Nhận Diện Cảm Xúc</button>
        <button class="tab-btn" data-tab="productivity">💼 Hỗ Trợ Công Việc</button>
        <button class="tab-btn" data-tab="analytics">📊 Thống Kê</button>
        <button class="tab-btn" data-tab="assistant">🤖 AI Trợ Lý</button>
    </div>

    <!-- AI Chat Button (Floating) -->
    <button id="chatToggle" class="chat-toggle" onclick="toggleChat()">
        💬
    </button>

    <!-- AI Chat Panel -->
    <div id="chatPanel" class="chat-panel">
        <div class="chat-header">
            <h3>🤖 AI Trợ Lý Thông Minh</h3>
            <button onclick="toggleChat()" class="chat-close">✕</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message chat-message-bot">
                <div class="message-avatar">🤖</div>
                <div class="message-content">
                    <div class="message-text">
                        Xin chào! Tôi là AI Assistant. Tôi có thể giúp bạn:<br><br>
                        ✅ Theo dõi năng suất làm việc<br>
                        ✅ Phát hiện căng thẳng, mệt mỏi<br>
                        ✅ Đề xuất nghỉ ngơi thông minh<br>
                        ✅ Báo cáo & thống kê<br>
                        ✅ Điều khiển Pomodoro<br><br>
                        Hãy hỏi tôi bất cứ điều gì!
                    </div>
                </div>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Nhập tin nhắn..." onkeypress="if(event.key==='Enter') sendMessage()" />
            <button onclick="sendMessage()" class="btn-send">📤</button>
            <button onclick="toggleVoice()" id="voiceBtn" class="btn-voice">🎤</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <header>
            <h1 id="mainTitle">🎭 AI Trợ Lý Công Việc</h1>
            <p class="subtitle">Nhận diện cảm xúc & hỗ trợ năng suất làm việc với AI</p>
        </header>

        <!-- Loading Status -->
        <div id="status" class="status">
            <span id="statusText">Đang tải mô hình AI...</span>
            <div class="loader"></div>
        </div>

        <!-- Video & Canvas Container -->
        <div class="video-container">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="canvas"></canvas>
        </div>

        <!-- Control Buttons -->
        <div class="controls">
            <button id="startBtn" disabled>
                <span class="btn-icon">▶️</span>
                <span class="btn-text">Bắt Đầu</span>
            </button>
            <button id="stopBtn" disabled>
                <span class="btn-icon">⏹️</span>
                <span class="btn-text">Dừng Lại</span>
            </button>
        </div>

        <!-- Emotion Display -->
        <div id="emotionDisplay" class="emotion-display">
            <div id="emotionEmoji" class="emotion-emoji">🤖</div>
            <div id="emotionText" class="emotion-text">Đang chờ...</div>
            <div id="emotionMessage" class="emotion-message">Nhấn "Bắt Đầu" để nhận diện cảm xúc</div>
        </div>

        <!-- Statistics -->
        <div id="stats" class="stats">
            <div class="stat-item">
                <span class="stat-label">FPS:</span>
                <span id="fps" class="stat-value">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Độ chính xác:</span>
                <span id="confidence" class="stat-value">0%</span>
            </div>
        </div>

        <!-- ============================================
             PRODUCTIVITY TAB - HỖ TRỢ CÔNG VIỆC
        ============================================ -->
        <div id="productivityTab" class="tab-content" style="display: none;">
            <!-- Trạng thái làm việc -->
            <div id="workState" class="section-card">
                <h2>📊 Trạng Thái Làm Việc</h2>
                <p class="hint">Đang phân tích trạng thái của bạn...</p>
            </div>

            <!-- Pomodoro Timer -->
            <div class="section-card">
                <h2>🍅 Pomodoro Timer</h2>
                <div id="pomodoroTimer">
                    <p class="hint">Timer sẽ xuất hiện khi bạn bắt đầu nhận diện</p>
                </div>
            </div>

            <!-- Ghi chú công việc -->
            <div class="section-card">
                <h2>📝 Ghi Chú Công Việc</h2>
                <div class="note-input-group">
                    <input type="text" id="noteInput" placeholder="Thêm ghi chú về công việc..." />
                    <button onclick="addNote()" class="btn-primary">➕ Thêm</button>
                </div>
                <div id="workNotes" class="work-notes-container">
                    <p class="no-notes">Chưa có ghi chú nào. Thêm ghi chú đầu tiên!</p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="section-card">
                <h2>⚡ Hành Động Nhanh</h2>
                <div class="quick-actions">
                    <button onclick="if(window.productivityTracker) window.productivityTracker.exportData()" class="action-btn">
                        💾 Xuất báo cáo
                    </button>
                    <button onclick="if(window.productivityTracker && confirm('Xóa tất cả dữ liệu?')) window.productivityTracker.resetData()" class="action-btn danger">
                        🗑️ Xóa dữ liệu
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================
             ANALYTICS TAB - THỐNG KÊ
        ============================================ -->
        <div id="analyticsTab" class="tab-content" style="display: none;">
            <!-- Thống kê tổng quan -->
            <div class="section-card">
                <h2>📈 Thống Kê Năng Suất</h2>
                <div id="productivityStats">
                    <p class="hint">Thống kê sẽ xuất hiện khi bạn bắt đầu làm việc</p>
                </div>
            </div>

            <!-- Biểu đồ cảm xúc -->
            <div class="section-card">
                <h2>🎭 Phân Bố Cảm Xúc</h2>
                <div id="emotionChart" class="emotion-chart">
                    <p class="hint">Biểu đồ sẽ xuất hiện sau khi thu thập dữ liệu</p>
                </div>
            </div>

            <!-- Lịch sử cảm xúc -->
            <div class="section-card">
                <h2>📊 Lịch Sử Cảm Xúc</h2>
                <div id="emotionTimeline" class="emotion-timeline">
                    <p class="hint">Timeline sẽ hiển thị lịch sử cảm xúc của bạn</p>
                </div>
            </div>

            <!-- Tips & Recommendations -->
            <div class="section-card">
                <h2>💡 Gợi Ý Cải Thiện</h2>
                <div id="recommendations" class="recommendations">
                    <div class="tip-card">
                        <div class="tip-icon">🎯</div>
                        <div class="tip-text">Hãy duy trì trạng thái tập trung bằng kỹ thuật Pomodoro</div>
                    </div>
                    <div class="tip-card">
                        <div class="tip-icon">☕</div>
                        <div class="tip-text">Nghỉ ngơi 5-10 phút sau mỗi 25 phút làm việc</div>
                    </div>
                    <div class="tip-card">
                        <div class="tip-icon">😌</div>
                        <div class="tip-text">Thực hiện bài tập thở sâu khi cảm thấy căng thẳng</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================
             AI ASSISTANT TAB - TRỢ LÝ ẢO
        ============================================ -->
        <div id="assistantTab" class="tab-content" style="display: none;">
            <!-- Chế độ tự động -->
            <div class="section-card">
                <h2>⚙️ Cài Đặt Tự Động</h2>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label class="switch">
                            <input type="checkbox" id="autoModeToggle" onchange="toggleAutoMode()" checked>
                            <span class="slider"></span>
                        </label>
                        <div class="setting-label">
                            <strong>🤖 Chế độ tự động</strong>
                            <p>Tự động phát hiện và cảnh báo</p>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <label class="switch">
                            <input type="checkbox" id="alertsToggle" checked>
                            <span class="slider"></span>
                        </label>
                        <div class="setting-label">
                            <strong>🔔 Cảnh báo</strong>
                            <p>Nhận cảnh báo về sức khỏe</p>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <label class="switch">
                            <input type="checkbox" id="suggestionsToggle" checked>
                            <span class="slider"></span>
                        </label>
                        <div class="setting-label">
                            <strong>💡 Gợi ý</strong>
                            <p>Nhận gợi ý thông minh</p>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <label class="switch">
                            <input type="checkbox" id="voiceToggle">
                            <span class="slider"></span>
                        </label>
                        <div class="setting-label">
                            <strong>🔊 Giọng nói</strong>
                            <p>Đọc cảnh báo bằng giọng</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ngưỡng cảnh báo -->
            <div class="section-card">
                <h2>⚠️ Ngưỡng Cảnh Báo</h2>
                <div class="threshold-settings">
                    <div class="threshold-item">
                        <label>Căng thẳng liên tục (lần):</label>
                        <input type="number" id="stressThreshold" value="3" min="1" max="10" />
                    </div>
                    <div class="threshold-item">
                        <label>Mệt mỏi liên tục (lần):</label>
                        <input type="number" id="tiredThreshold" value="5" min="1" max="10" />
                    </div>
                    <div class="threshold-item">
                        <label>Điểm tập trung tối thiểu:</label>
                        <input type="number" id="focusThreshold" value="40" min="0" max="100" />
                    </div>
                    <div class="threshold-item">
                        <label>Không phát hiện khuôn mặt (lần):</label>
                        <input type="number" id="absenceThreshold" value="10" min="1" max="20" />
                    </div>
                </div>
                <button onclick="updateThresholds()" class="btn-primary">💾 Lưu cài đặt</button>
            </div>

            <!-- Lịch sử cảnh báo -->
            <div class="section-card">
                <h2>📜 Lịch Sử Cảnh Báo</h2>
                <div id="alertHistory" class="alert-history">
                    <p class="hint">Lịch sử cảnh báo sẽ hiển thị ở đây</p>
                </div>
            </div>

            <!-- Kịch bản sử dụng -->
            <div class="section-card">
                <h2>🎯 Kịch Bản Sử Dụng</h2>
                <div class="use-cases">
                    <div class="use-case-card">
                        <div class="use-case-icon">📚</div>
                        <h3>Học sinh / Sinh viên</h3>
                        <ul>
                            <li>✅ Theo dõi thời gian học tập</li>
                            <li>✅ Phát hiện mất tập trung</li>
                            <li>✅ Chống gian lận thi online</li>
                            <li>✅ Nhắc nghỉ ngơi khi căng thẳng</li>
                        </ul>
                    </div>
                    
                    <div class="use-case-card">
                        <div class="use-case-icon">💼</div>
                        <h3>Nhân viên Remote</h3>
                        <ul>
                            <li>✅ Tính giờ làm việc chính xác</li>
                            <li>✅ Báo cáo năng suất cho quản lý</li>
                            <li>✅ Phát hiện vắng mặt</li>
                            <li>✅ Theo dõi hiệu suất</li>
                        </ul>
                    </div>
                    
                    <div class="use-case-card">
                        <div class="use-case-icon">🧑‍💼</div>
                        <h3>Freelancer</h3>
                        <ul>
                            <li>✅ Theo dõi thời gian dự án</li>
                            <li>✅ Tối ưu năng suất</li>
                            <li>✅ Quản lý nhiều task</li>
                            <li>✅ Xuất báo cáo cho khách hàng</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Audio Elements -->
    <audio id="happySound" loop></audio>
    <audio id="sadSound" loop></audio>
    <audio id="calmSound" loop></audio>

    <!-- JavaScript Files with error handling -->
    <script>
        // Prevent duplicate variable declarations globally
        window.EmotionApp = window.EmotionApp || {};
        
        // Enhanced error handling
        window.addEventListener('error', function(e) {
            const suppressedErrors = [
                'WebGL is not supported',
                'WebGL context could not be created', 
                'WASM loading failed',
                'already declared',
                'Cannot redefine property',
                'productivityTracker'
            ];
            
            if (suppressedErrors.some(err => e.message && e.message.includes(err))) {
                console.warn('🛡️ Suppressed error:', e.message);
                e.preventDefault();
                return false;
            }
        });
    </script>
    
    <script src="js/config.js"></script>
    <script src="js/emotions.js"></script>
    <script src="js/camera.js"></script>
    
    <!-- Productivity with duplicate prevention -->
    <script>
        if (typeof productivityTracker === 'undefined') {
            window.productivityTrackerLoaded = false;
        } else {
            window.productivityTrackerLoaded = true;
            console.warn('🛡️ productivityTracker already exists, skipping duplicate load');
        }
    </script>
    <script src="js/productivity.js"></script>
    
    <script src="js/ai-assistant.js"></script>
    
    <!-- Enhanced app.js with backend fallback -->
    <script>
        (function() {
            // Load original app.js and enhance it
            const script = document.createElement('script');
            script.src = 'js/app.js';
            script.async = false;
            
            script.onload = function() {
                console.log('✅ App.js loaded, adding backend fallback...');
                
                // Override initApp with smart backend detection
                if (typeof window.initApp === 'function') {
                    const originalInitApp = window.initApp;
                    
                    window.initApp = async function() {
                        try {
                            // Check if Face-API is available
                            if (typeof faceapi === 'undefined') {
                                throw new Error('Face-API not loaded');
                            }
                            
                            console.log('🚀 Starting enhanced app with backend fallback...');
                            
                            // Try backends in order: webgl -> wasm -> cpu
                            const backends = ['webgl', 'wasm', 'cpu'];
                            let success = false;
                            
                            for (const backend of backends) {
                                try {
                                    console.log(`🔄 Trying ${backend.toUpperCase()} backend...`);
                                    
                                    // Set backend first
                                    await faceapi.tf.setBackend(backend);
                                    await faceapi.tf.ready();
                                    
                                    // Load models
                                    await faceapi.nets.tinyFaceDetector.loadFromUri('./models');
                                    await faceapi.nets.faceExpressionNet.loadFromUri('./models');
                                    
                                    success = true;
                                    console.log(`✅ Successfully initialized ${backend.toUpperCase()} backend`);
                                    break;
                                } catch (error) {
                                    console.warn(`❌ ${backend.toUpperCase()} backend failed:`, error.message);
                                    continue;
                                }
                            }
                            
                            if (!success) {
                                throw new Error('All TensorFlow backends failed to initialize');
                            }
                            
                            // Call original initialization
                            return originalInitApp();
                            
                        } catch (error) {
                            console.error('❌ Enhanced app initialization failed:', error);
                            
                            // Fallback UI
                            const statusElement = document.getElementById('status');
                            if (statusElement) {
                                statusElement.innerHTML = `
                                    <div style="color: red; text-align: center; padding: 20px;">
                                        ⚠️ <strong>Không thể khởi tạo ứng dụng</strong><br>
                                        <small>Lỗi: ${error.message}</small><br>
                                        <button onclick="location.reload()" style="margin-top: 10px; padding: 5px 10px;">🔄 Thử lại</button>
                                    </div>
                                `;
                            }
                            throw error;
                        }
                    };
                }
            };
            
            script.onerror = function() {
                console.error('❌ Failed to load app.js');
            };
            
            document.head.appendChild(script);
        })();
    </script>
    
    <!-- Initialize Global Objects -->
    <script>
        // Khởi tạo ProductivityTracker và AIAssistant sau khi tất cả scripts loaded
        // Check if already declared to prevent duplicates
        if (typeof productivityTracker === 'undefined') {
            var productivityTracker = null;
        }
        if (typeof aiAssistant === 'undefined') {
            var aiAssistant = null;
        }
        
        // Chờ window load hoàn toàn
        window.addEventListener('load', () => {
            console.log('🔧 Page loaded, initializing systems...');
            
            // Đợi thêm 500ms để đảm bảo tất cả scripts đã parse xong
            setTimeout(() => {
                try {
                    console.log('🔍 Checking ProductivityTracker class...');
                    
                    // Khởi tạo ProductivityTracker
                    if (typeof ProductivityTracker !== 'undefined') {
                        console.log('✅ ProductivityTracker class found, creating instance...');
                        productivityTracker = new ProductivityTracker();
                        window.productivityTracker = productivityTracker;
                        console.log('✅ ProductivityTracker initialized successfully!');
                        console.log('   Methods available:', Object.getOwnPropertyNames(Object.getPrototypeOf(productivityTracker)).slice(0, 5).join(', '));
                    } else {
                        console.error('❌ ProductivityTracker class not found! Check js/productivity.js');
                        alert('❌ Lỗi: Không tìm thấy ProductivityTracker class. Kiểm tra file js/productivity.js');
                        return;
                    }
                    
                    console.log('🔍 Checking AIAssistant class...');
                    
                    // Khởi tạo AIAssistant
                    if (typeof AIAssistant !== 'undefined' && productivityTracker) {
                        console.log('✅ AIAssistant class found, creating instance...');
                        aiAssistant = new AIAssistant(productivityTracker);
                        window.aiAssistant = aiAssistant;
                        console.log('✅ AIAssistant initialized successfully!');
                        console.log('   Auto mode enabled:', aiAssistant.autoMode.enabled);
                    } else {
                        console.error('❌ AIAssistant class not found! Check js/ai-assistant.js');
                        alert('❌ Lỗi: Không tìm thấy AIAssistant class. Kiểm tra file js/ai-assistant.js');
                        return;
                    }
                    
                    console.log('🎨 Updating UI...');
                    
                    // Cập nhật UI ban đầu
                    if (productivityTracker) {
                        try {
                            updateProductivityUI();
                            console.log('✅ Productivity UI updated');
                        } catch (err) {
                            console.error('❌ Error updating Productivity UI:', err);
                        }
                        
                        try {
                            updateAnalytics();
                            console.log('✅ Analytics updated');
                        } catch (err) {
                            console.error('❌ Error updating Analytics:', err);
                        }
                    }
                    
                    console.log('🎉 All systems initialized successfully!');
                    console.log('✅ You can now use:');
                    console.log('   - window.productivityTracker');
                    console.log('   - window.aiAssistant');
                    
                } catch (error) {
                    console.error('❌ CRITICAL ERROR initializing systems:', error);
                    console.error('Error stack:', error.stack);
                    alert('❌ Lỗi nghiêm trọng khi khởi tạo: ' + error.message + '\n\nXem Console (F12) để biết chi tiết.');
                }
            }, 500);
        });
        
        // Update UI functions
        function updateProductivityUI() {
            if (!window.productivityTracker) return;
            
            // Update Pomodoro display
            const pomodoroTimer = document.getElementById('pomodoroTimer');
            if (pomodoroTimer) {
                pomodoroTimer.innerHTML = `
                    <div class="pomodoro-display">
                        <div class="timer-circle">
                            <div class="timer-time" id="timerDisplay">25:00</div>
                            <div class="timer-label" id="timerLabel">Sẵn sàng</div>
                        </div>
                        <div class="timer-controls">
                            <button onclick="startPomodoro()" class="btn-pomodoro btn-start">
                                ▶️ Bắt đầu
                            </button>
                            <button onclick="pausePomodoro()" class="btn-pomodoro btn-pause" disabled>
                                ⏸️ Tạm dừng
                            </button>
                            <button onclick="resetPomodoro()" class="btn-pomodoro btn-reset">
                                🔄 Đặt lại
                            </button>
                        </div>
                        <div class="pomodoro-stats">
                            <div class="stat">
                                <span class="stat-value" id="pomodoroCount">0</span>
                                <span class="stat-label">Phiên hoàn thành</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Update work notes
            updateWorkNotes();
            
            // Update productivity stats
            const statsDiv = document.getElementById('productivityStats');
            if (statsDiv && window.productivityTracker) {
                const stats = window.productivityTracker.getCurrentStats();
                statsDiv.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">⏰</div>
                            <div class="stat-content">
                                <div class="stat-value">${formatTime(stats.totalWorkTime)}</div>
                                <div class="stat-label">Tổng thời gian làm việc</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">😊</div>
                            <div class="stat-content">
                                <div class="stat-value">${formatTime(stats.focusedTime)}</div>
                                <div class="stat-label">Thời gian tập trung</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">😔</div>
                            <div class="stat-content">
                                <div class="stat-value">${formatTime(stats.distractedTime)}</div>
                                <div class="stat-label">Thời gian mất tập trung</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🎯</div>
                            <div class="stat-content">
                                <div class="stat-value">${Math.round(window.productivityTracker.focusScore)}</div>
                                <div class="stat-label">Điểm tập trung</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hrs > 0) {
                return `${hrs}g ${mins}p`;
            } else if (mins > 0) {
                return `${mins}p ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }
        
        // Pomodoro functions with error handling
        function startPomodoro() {
            console.log('🍅 startPomodoro() called');
            if (!window.productivityTracker) {
                console.error('❌ ProductivityTracker not initialized!');
                alert('❌ Lỗi: Hệ thống chưa sẵn sàng. Hãy reload trang.');
                return;
            }
            
            try {
                window.productivityTracker.startPomodoro();
                updatePomodoroButtons(true, false, false);
                console.log('✅ Pomodoro started');
            } catch (error) {
                console.error('❌ Error starting Pomodoro:', error);
                alert('❌ Lỗi khi bắt đầu Pomodoro: ' + error.message);
            }
        }
        
        function pausePomodoro() {
            console.log('⏸️ pausePomodoro() called');
            if (!window.productivityTracker) {
                console.error('❌ ProductivityTracker not initialized!');
                return;
            }
            
            try {
                window.productivityTracker.pausePomodoro();
                updatePomodoroButtons(false, true, false);
                console.log('✅ Pomodoro paused');
            } catch (error) {
                console.error('❌ Error pausing Pomodoro:', error);
                alert('❌ Lỗi khi tạm dừng Pomodoro: ' + error.message);
            }
        }
        
        function resetPomodoro() {
            console.log('🔄 resetPomodoro() called');
            if (!window.productivityTracker) {
                console.error('❌ ProductivityTracker not initialized!');
                return;
            }
            
            try {
                window.productivityTracker.resetPomodoro();
                updatePomodoroButtons(false, false, false);
                console.log('✅ Pomodoro reset');
            } catch (error) {
                console.error('❌ Error resetting Pomodoro:', error);
                alert('❌ Lỗi khi reset Pomodoro: ' + error.message);
            }
        }
        
        function updatePomodoroButtons(startDisabled, pauseDisabled, resetDisabled) {
            const startBtn = document.querySelector('.btn-start');
            const pauseBtn = document.querySelector('.btn-pause');
            const resetBtn = document.querySelector('.btn-reset');
            
            if (startBtn) startBtn.disabled = startDisabled;
            if (pauseBtn) pauseBtn.disabled = pauseDisabled;
            if (resetBtn) resetBtn.disabled = resetDisabled;
        }
        
        // Work notes functions with error handling
        function addNote() {
            console.log('📝 addNote() called');
            const input = document.getElementById('noteInput');
            
            if (!input) {
                console.error('❌ Note input element not found!');
                return;
            }
            
            const note = input.value.trim();
            
            if (!note) {
                alert('⚠️ Vui lòng nhập nội dung ghi chú!');
                return;
            }
            
            if (!window.productivityTracker) {
                console.error('❌ ProductivityTracker not initialized!');
                alert('❌ Lỗi: Hệ thống chưa sẵn sàng. Hãy reload trang.');
                return;
            }
            
            try {
                window.productivityTracker.addWorkNote(note);
                input.value = '';
                updateWorkNotes();
                console.log('✅ Note added:', note);
            } catch (error) {
                console.error('❌ Error adding note:', error);
                alert('❌ Lỗi khi thêm ghi chú: ' + error.message);
            }
        }
        
        function updateWorkNotes() {
            if (!window.productivityTracker) return;
            
            const container = document.getElementById('workNotes');
            const notes = window.productivityTracker.workNotes || [];
            
            if (notes.length === 0) {
                container.innerHTML = '<p class="no-notes">Chưa có ghi chú nào. Thêm ghi chú đầu tiên!</p>';
                return;
            }
            
            const notesHTML = notes.map((note, index) => `
                <div class="note-item">
                    <div class="note-content">
                        <div class="note-text">${note.note}</div>
                        <div class="note-time">${new Date(note.timestamp).toLocaleString('vi-VN')}</div>
                    </div>
                    <button onclick="deleteNote(${index})" class="note-delete">🗑️</button>
                </div>
            `).join('');
            
            container.innerHTML = notesHTML;
        }
        
        function deleteNote(index) {
            if (window.productivityTracker) {
                window.productivityTracker.workNotes.splice(index, 1);
                window.productivityTracker.saveData();
                updateWorkNotes();
            }
        }
    </script>
    
    <!-- Chat & Assistant Functions -->
    <script>
        function toggleChat() {
            const chatPanel = document.getElementById('chatPanel');
            const chatToggle = document.getElementById('chatToggle');
            
            if (chatPanel.classList.contains('show')) {
                chatPanel.classList.remove('show');
                chatToggle.style.display = 'flex';
            } else {
                chatPanel.classList.add('show');
                chatToggle.style.display = 'none';
            }
        }
        
        function sendMessage() {
            console.log('💬 sendMessage() called');
            const input = document.getElementById('chatInput');
            
            if (!input) {
                console.error('❌ Chat input element not found!');
                return;
            }
            
            const message = input.value.trim();
            
            if (!message) {
                console.log('⚠️ Empty message, ignoring');
                return;
            }
            
            if (!window.aiAssistant) {
                console.error('❌ AIAssistant not initialized!');
                alert('❌ Lỗi: AI Assistant chưa sẵn sàng. Hãy reload trang.');
                return;
            }
            
            try {
                console.log('📤 Sending message:', message);
                window.aiAssistant.processMessage(message);
                input.value = '';
                console.log('✅ Message sent');
            } catch (error) {
                console.error('❌ Error sending message:', error);
                alert('❌ Lỗi khi gửi tin nhắn: ' + error.message);
            }
        }
        
        function toggleVoice() {
            console.log('🎤 toggleVoice() called');
            
            if (!window.aiAssistant) {
                console.error('❌ AIAssistant not initialized!');
                alert('❌ Lỗi: AI Assistant chưa sẵn sàng.');
                return;
            }
            
            try {
                if (window.aiAssistant.isListening) {
                    window.aiAssistant.stopListening();
                    console.log('✅ Voice stopped');
                } else {
                    window.aiAssistant.startListening();
                    console.log('✅ Voice started');
                }
            } catch (error) {
                console.error('❌ Error toggling voice:', error);
                alert('❌ Lỗi khi bật/tắt giọng nói: ' + error.message);
            }
        }
        
        function toggleAutoMode() {
            console.log('🤖 toggleAutoMode() called');
            
            if (!window.aiAssistant) {
                console.error('❌ AIAssistant not initialized!');
                return;
            }
            
            try {
                window.aiAssistant.toggleAutoMode();
                console.log('✅ Auto mode toggled:', window.aiAssistant.autoMode.enabled);
            } catch (error) {
                console.error('❌ Error toggling auto mode:', error);
            }
        }
        
        function updateThresholds() {
            if (window.aiAssistant) {
                const thresholds = {
                    stressLevel: parseInt(document.getElementById('stressThreshold').value),
                    tirednessLevel: parseInt(document.getElementById('tiredThreshold').value),
                    focusDropLevel: parseInt(document.getElementById('focusThreshold').value),
                    noFaceDetected: parseInt(document.getElementById('absenceThreshold').value)
                };
                
                window.aiAssistant.thresholds = thresholds;
                window.aiAssistant.saveSettings();
                
                alert('✅ Đã lưu cài đặt!');
            }
        }
    </script>
    
    <!-- Tab Switching Script -->
    <script>
        // Tab Navigation
        document.addEventListener('DOMContentLoaded', () => {
            const tabBtns = document.querySelectorAll('.tab-btn');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        });
        
        function switchTab(tabName) {
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Hide all tab contents
            const emotionContent = document.querySelector('.video-container').parentElement;
            document.getElementById('productivityTab').style.display = 'none';
            document.getElementById('analyticsTab').style.display = 'none';
            document.getElementById('assistantTab').style.display = 'none';
            
            // Show emotion detection elements
            const emotionElements = [
                '.video-container', '.controls', '#emotionDisplay', '#stats'
            ];
            
            // Show selected tab
            if (tabName === 'emotion') {
                emotionElements.forEach(selector => {
                    const el = document.querySelector(selector);
                    if (el) el.style.display = '';
                });
            } else if (tabName === 'productivity') {
                emotionElements.forEach(selector => {
                    const el = document.querySelector(selector);
                    if (el) el.style.display = 'none';
                });
                document.getElementById('productivityTab').style.display = 'block';
            } else if (tabName === 'analytics') {
                emotionElements.forEach(selector => {
                    const el = document.querySelector(selector);
                    if (el) el.style.display = 'none';
                });
                document.getElementById('analyticsTab').style.display = 'block';
                updateAnalytics();
            } else if (tabName === 'assistant') {
                emotionElements.forEach(selector => {
                    const el = document.querySelector(selector);
                    if (el) el.style.display = 'none';
                });
                document.getElementById('assistantTab').style.display = 'block';
                loadAlertHistory();
            }
        }
        
        function loadAlertHistory() {
            const historyContainer = document.getElementById('alertHistory');
            const logs = JSON.parse(localStorage.getItem('alertLogs') || '[]');
            
            if (logs.length === 0) {
                historyContainer.innerHTML = '<p class="hint">Chưa có cảnh báo nào</p>';
                return;
            }
            
            const historyHTML = logs.slice(0, 20).map(log => {
                const date = new Date(log.timestamp);
                const priorityClass = `priority-${log.priority}`;
                
                return `
                    <div class="history-item ${priorityClass}">
                        <div class="history-time">${date.toLocaleString('vi-VN')}</div>
                        <div class="history-title">${log.title}</div>
                        <div class="history-message">${log.message}</div>
                    </div>
                `;
            }).join('');
            
            historyContainer.innerHTML = historyHTML;
        }
        
        // addNote() function is defined above in "Initialize Global Objects" script
        // Removed duplicate to avoid "already declared" error
        
        function updateAnalytics() {
            if (!window.productivityTracker) return;
            
            // Update stats
            window.productivityTracker.updateStatsDisplay();
            
            // Update emotion chart
            const chartData = window.productivityTracker.generateEmotionChart();
            const chartContainer = document.getElementById('emotionChart');
            
            if (chartData.length > 0) {
                const chartHTML = chartData.map(item => `
                    <div class="chart-bar">
                        <div class="chart-label">${window.productivityTracker.getEmotionEmoji(item.emotion)} ${item.emotion}</div>
                        <div class="chart-bar-bg">
                            <div class="chart-bar-fill" style="width: ${item.percentage}%"></div>
                        </div>
                        <div class="chart-value">${item.percentage}%</div>
                    </div>
                `).join('');
                
                chartContainer.innerHTML = chartHTML;
            }
            
            // Update timeline
            updateEmotionTimeline();
        }
        
        function updateEmotionTimeline() {
            if (!window.productivityTracker) return;
            
            const timeline = document.getElementById('emotionTimeline');
            const history = window.productivityTracker.emotionHistory.slice(-10).reverse();
            
            if (history.length === 0) {
                timeline.innerHTML = '<p class="hint">Chưa có dữ liệu lịch sử</p>';
                return;
            }
            
            const timelineHTML = history.map(item => {
                const date = new Date(item.timestamp);
                const emoji = window.productivityTracker.getEmotionEmoji(item.emotion);
                
                return `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <span class="timeline-emoji">${emoji}</span>
                            <span class="timeline-emotion">${item.emotion}</span>
                            <span class="timeline-score">Tập trung: ${item.focusScore}/100</span>
                            <span class="timeline-time">${date.toLocaleTimeString('vi-VN')}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            timeline.innerHTML = timelineHTML;
        }
        
        // Allow Enter key to add note
        document.addEventListener('DOMContentLoaded', () => {
            const noteInput = document.getElementById('noteInput');
            if (noteInput) {
                noteInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addNote();
                    }
                });
            }
        });
    </script>
</body>
</html>
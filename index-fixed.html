<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ AI Emotion Detection - Production App</title>
    
    <!-- Face-API.js with fallback CDN -->
    <script defer crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/productivity.css">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #ffffff;
            --text: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text);
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* Header */
        .app-header {
            background: var(--bg);
            border-radius: 16px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .app-header h1 {
            font-size: clamp(20px, 5vw, 28px);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-section { display: flex; align-items: center; gap: 15px; }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-profile:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--bg);
            padding: 10px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        .tab-btn {
            flex: 1;
            min-width: 150px;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: var(--shadow);
        }

        .tab-btn:hover:not(.active) { background: var(--border); }

        /* Tab Content */
        .tab-content {
            display: none;
            background: var(--bg);
            border-radius: 16px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            animation: fadeIn 0.3s;
        }

        .tab-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Camera Section */
        .camera-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .camera-grid { grid-template-columns: 1fr; }
        }

        .video-box {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            aspect-ratio: 16/9;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #overlay {
            position: absolute;
            top: 0;
            left: 0;
        }

        .emotion-panel {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .emotion-display {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .emotion-emoji { font-size: 80px; display: block; margin-bottom: 10px; }
        .emotion-label { font-size: 24px; font-weight: 700; color: var(--primary); }
        .emotion-confidence { font-size: 14px; color: var(--text-secondary); margin-top: 5px; }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 450px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header { margin-bottom: 25px; }

        .modal-header h2 {
            font-size: 28px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-group { margin-bottom: 20px; }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input,
        .note-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .note-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .modal-footer .btn { flex: 1; }

        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active { display: flex; }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Alert */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid var(--success); }
        .alert-error { background: #fee2e2; color: #991b1b; border-left: 4px solid var(--danger); }
        .alert-warning { background: #fef3c7; color: #92400e; border-left: 4px solid var(--warning); }

        /* Charts */
        .chart-box {
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        canvas { max-height: 400px; }

        /* Notes */
        .notes-section { margin-top: 30px; }

        .note-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .note-input { flex: 1; }

        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .note-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 10px;
        }

        .note-content { flex: 1; }
        .note-text { font-size: 16px; margin-bottom: 5px; }
        .note-time { font-size: 12px; color: var(--text-secondary); }

        /* Export */
        .export-section {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border-radius: 12px;
        }

        .export-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="authModalTitle">üîê ƒêƒÉng Nh·∫≠p</h2>
            </div>
            <div id="authError"></div>
            <form id="authForm">
                <div class="form-group" id="nameGroup" style="display: none;">
                    <label for="authName">H·ªç v√† T√™n</label>
                    <input type="text" id="authName" placeholder="Nh·∫≠p h·ªç t√™n">
                </div>
                <div class="form-group">
                    <label for="authEmail">Email</label>
                    <input type="email" id="authEmail" placeholder="email@example.com" required>
                </div>
                <div class="form-group">
                    <label for="authPassword">M·∫≠t kh·∫©u</label>
                    <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" onclick="closeAuthModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-primary" id="authSubmitBtn">ƒêƒÉng Nh·∫≠p</button>
                </div>
            </form>
            <div style="text-align: center; margin-top: 15px;">
                <a href="#" id="authToggleLink" onclick="toggleAuthMode(event)" style="color: var(--primary);">
                    Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω
                </a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="app-header">
            <h1>üé≠ AI Emotion Detection</h1>
            <div class="user-section">
                <div id="userProfile" style="display: none;" class="user-profile">
                    <span>üë§</span>
                    <span id="userName"></span>
                    <button onclick="logout()" class="btn" style="padding: 6px 12px; margin-left: 10px;">
                        ƒêƒÉng xu·∫•t
                    </button>
                </div>
                <button id="loginBtn" class="btn btn-primary" onclick="openAuthModal('login')">
                    üîê ƒêƒÉng Nh·∫≠p
                </button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('emotion')">üé≠ Nh·∫≠n Di·ªán</button>
            <button class="tab-btn" onclick="switchTab('productivity')">üíº C√¥ng Vi·ªác</button>
            <button class="tab-btn" onclick="switchTab('analytics')">üìä Th·ªëng K√™</button>
            <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è C√†i ƒê·∫∑t</button>
        </div>

        <!-- Emotion Tab -->
        <div id="emotionTab" class="tab-content active">
            <h2 style="margin-bottom: 20px;">üé≠ Nh·∫≠n Di·ªán C·∫£m X√∫c Th·ªùi Gian Th·ª±c</h2>
            
            <div class="camera-grid">
                <div class="video-box">
                    <video id="video" autoplay muted playsinline></video>
                    <canvas id="overlay"></canvas>
                </div>
                
                <div class="emotion-panel">
                    <div class="emotion-display">
                        <span id="emotionEmoji" class="emotion-emoji">üòä</span>
                        <div id="emotionLabel" class="emotion-label">ƒêang ph√°t hi·ªán...</div>
                        <div id="emotionConfidence" class="emotion-confidence">ƒê·ªô ch√≠nh x√°c: --</div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">T√¢m tr·∫°ng</div>
                            <div class="stat-value" id="dominantEmotion">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">ƒê·ªô t·∫≠p trung</div>
                            <div class="stat-value" id="focusScore">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button id="startBtn" class="btn btn-primary" onclick="startCamera()">
                    üìπ B·∫≠t Camera
                </button>
                <button id="stopBtn" class="btn btn-danger" onclick="stopCamera()" disabled>
                    ‚èπÔ∏è D·ª´ng
                </button>
                <button class="btn btn-success" onclick="captureSnapshot()">
                    üì∏ Ch·ª•p ·∫¢nh
                </button>
            </div>

            <div id="statusMessage"></div>
        </div>

        <!-- Productivity Tab -->
        <div id="productivityTab" class="tab-content">
            <h2 style="margin-bottom: 20px;">üíº H·ªó Tr·ª£ C√¥ng Vi·ªác</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">‚è±Ô∏è Th·ªùi gian</div>
                    <div class="stat-value" id="workTime">0h 0m</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">‚úÖ Ho√†n th√†nh</div>
                    <div class="stat-value" id="tasksCompleted">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üéØ Hi·ªáu su·∫•t</div>
                    <div class="stat-value" id="productivity">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üî• Streak</div>
                    <div class="stat-value" id="streak">0 ng√†y</div>
                </div>
            </div>

            <div class="export-section">
                <div class="export-header">
                    <h3>üì§ Xu·∫•t B√°o C√°o</h3>
                    <div class="export-buttons">
                        <button class="btn btn-primary" onclick="exportToPDF()">üìÑ PDF</button>
                        <button class="btn btn-success" onclick="exportToCSV()">üìä CSV</button>
                    </div>
                </div>
                <p style="color: var(--text-secondary);">
                    Xu·∫•t d·ªØ li·ªáu l√†m vi·ªác v√† c·∫£m x√∫c th√†nh file PDF ho·∫∑c CSV
                </p>
            </div>

            <div class="notes-section">
                <h3 style="margin-bottom: 15px;">üìù Ghi Ch√∫</h3>
                <div class="note-input-group">
                    <input type="text" id="noteInput" class="note-input" placeholder="Nh·∫≠p ghi ch√∫...">
                    <button class="btn btn-primary" onclick="addNote()">Th√™m</button>
                </div>
                <div id="notesList" class="notes-list"></div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analyticsTab" class="tab-content">
            <h2 style="margin-bottom: 20px;">üìä Th·ªëng K√™ & Ph√¢n T√≠ch</h2>
            
            <div class="chart-box">
                <h3 style="margin-bottom: 15px;">Bi·ªÉu ƒê·ªì C·∫£m X√∫c</h3>
                <canvas id="emotionChart"></canvas>
            </div>

            <div class="chart-box">
                <h3 style="margin-bottom: 15px;">NƒÉng Su·∫•t Theo Th·ªùi Gian</h3>
                <canvas id="productivityChart"></canvas>
            </div>

            <div class="chart-box">
                <h3 style="margin-bottom: 15px;">L·ªãch S·ª≠ C·∫£m X√∫c</h3>
                <canvas id="emotionHistoryChart"></canvas>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content">
            <h2 style="margin-bottom: 20px;">‚öôÔ∏è C√†i ƒê·∫∑t</h2>
            
            <div class="form-group">
                <label>üîî Th√¥ng b√°o</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="notificationsEnabled" checked>
                    <span>B·∫≠t th√¥ng b√°o khi ph√°t hi·ªán stress</span>
                </div>
            </div>

            <div class="form-group">
                <label>‚è∞ T·∫ßn su·∫•t ph√°t hi·ªán (ms)</label>
                <input type="number" id="detectionInterval" value="1000" min="100" max="5000">
            </div>

            <div class="form-group">
                <label>üéØ Ng∆∞·ª°ng ƒë·ªô tin c·∫≠y</label>
                <input type="range" id="confidenceThreshold" min="0" max="100" value="60">
                <span id="confidenceValue">60%</span>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="saveSettings()">üíæ L∆∞u</button>
                <button class="btn btn-danger" onclick="resetSettings()">üîÑ ƒê·∫∑t L·∫°i</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/export-service.js"></script>
    <script src="js/emotions.js"></script>
    <script src="js/productivity.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/app.js"></script>

    <script>
        // Global State
        let emotionApp = null;
        let charts = { emotion: null, productivity: null, emotionHistory: null };
        let isAuthMode = 'login';

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Initializing App...');
            showLoading();

            try {
                await waitForFaceAPI();
                
                if (typeof EmotionDetectionApp !== 'undefined') {
                    emotionApp = new EmotionDetectionApp();
                    await emotionApp.initialize();
                }
                
                initializeCharts();
                checkAuthStatus();
                displayNotes();
                loadSettings();
                
                hideLoading();
                showStatus('success', '‚úÖ S·∫µn s√†ng!');
            } catch (error) {
                console.error('Init error:', error);
                hideLoading();
                showStatus('error', '‚ùå L·ªói: ' + error.message);
            }
        });

        // Wait for Face-API
        function waitForFaceAPI() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const check = setInterval(() => {
                    if (typeof faceapi !== 'undefined') {
                        clearInterval(check);
                        console.log('‚úÖ Face-API loaded');
                        resolve();
                    } else if (++attempts >= 50) {
                        clearInterval(check);
                        reject(new Error('Face-API timeout'));
                    }
                }, 200);
            });
        }

        // Tab Switching
        function switchTab(name) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(name + 'Tab').classList.add('active');
            
            if (name === 'analytics') updateCharts();
        }

        // Camera Controls
        async function startCamera() {
            if (!emotionApp) return showStatus('error', '‚ùå App ch∆∞a s·∫µn s√†ng');
            
            showLoading();
            try {
                await emotionApp.startCamera();
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                showStatus('success', '‚úÖ Camera ƒë√£ b·∫≠t');
            } catch (err) {
                showStatus('error', '‚ùå L·ªói camera: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        function stopCamera() {
            if (!emotionApp) return;
            emotionApp.stopCamera();
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            showStatus('warning', '‚èπÔ∏è ƒê√£ d·ª´ng camera');
        }

        function captureSnapshot() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `emotion-${Date.now()}.png`;
                a.click();
                showStatus('success', 'üì∏ ƒê√£ l∆∞u!');
            });
        }

        // Auth
        function openAuthModal(mode) {
            isAuthMode = mode;
            const modal = document.getElementById('authModal');
            const title = document.getElementById('authModalTitle');
            const nameGroup = document.getElementById('nameGroup');
            const submitBtn = document.getElementById('authSubmitBtn');
            const toggleLink = document.getElementById('authToggleLink');
            
            if (mode === 'login') {
                title.textContent = 'üîê ƒêƒÉng Nh·∫≠p';
                nameGroup.style.display = 'none';
                submitBtn.textContent = 'ƒêƒÉng Nh·∫≠p';
                toggleLink.textContent = 'Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω';
            } else {
                title.textContent = 'üìù ƒêƒÉng K√Ω';
                nameGroup.style.display = 'block';
                submitBtn.textContent = 'ƒêƒÉng K√Ω';
                toggleLink.textContent = 'ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p';
            }
            
            modal.classList.add('active');
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('authForm').reset();
            document.getElementById('authError').innerHTML = '';
        }

        function toggleAuthMode(e) {
            e.preventDefault();
            openAuthModal(isAuthMode === 'login' ? 'register' : 'login');
        }

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const name = document.getElementById('authName').value;
            
            showLoading();
            
            try {
                let result;
                if (window.apiClient) {
                    result = isAuthMode === 'login' 
                        ? await apiClient.login(email, password)
                        : await apiClient.register(email, password, name);
                } else {
                    result = {
                        success: true,
                        user: { email, name: name || email },
                        token: 'test-' + Date.now()
                    };
                    localStorage.setItem('authToken', result.token);
                    localStorage.setItem('userData', JSON.stringify(result.user));
                }
                
                if (result.success) {
                    showUserProfile(result.user);
                    closeAuthModal();
                    showStatus('success', '‚úÖ Th√†nh c√¥ng!');
                } else {
                    document.getElementById('authError').innerHTML = 
                        `<div class="alert alert-error">${result.message}</div>`;
                }
            } catch (err) {
                document.getElementById('authError').innerHTML = 
                    `<div class="alert alert-error">‚ùå ${err.message}</div>`;
            } finally {
                hideLoading();
            }
        });

        function checkAuthStatus() {
            const token = localStorage.getItem('authToken');
            const user = JSON.parse(localStorage.getItem('userData') || 'null');
            if (token && user) showUserProfile(user);
        }

        function showUserProfile(user) {
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('userProfile').style.display = 'flex';
            document.getElementById('userName').textContent = user.name || user.email;
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('userProfile').style.display = 'none';
            showStatus('success', 'üëã ƒê√£ ƒëƒÉng xu·∫•t');
        }

        // Notes
        function addNote() {
            const input = document.getElementById('noteInput');
            const text = input.value.trim();
            if (!text) return;
            
            const notes = JSON.parse(localStorage.getItem('workNotes') || '[]');
            notes.unshift({
                id: Date.now(),
                text: text,
                timestamp: new Date().toISOString()
            });
            
            localStorage.setItem('workNotes', JSON.stringify(notes));
            input.value = '';
            displayNotes();
            showStatus('success', '‚úÖ ƒê√£ th√™m');
        }

        function displayNotes() {
            const notes = JSON.parse(localStorage.getItem('workNotes') || '[]');
            const container = document.getElementById('notesList');
            
            if (notes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Ch∆∞a c√≥ ghi ch√∫</p>';
                return;
            }
            
            container.innerHTML = notes.map(note => `
                <div class="note-item">
                    <div class="note-content">
                        <div class="note-text">${note.text}</div>
                        <div class="note-time">${new Date(note.timestamp).toLocaleString('vi-VN')}</div>
                    </div>
                    <button class="btn btn-danger" style="padding: 6px 12px;" onclick="deleteNote(${note.id})">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
        }

        function deleteNote(id) {
            const notes = JSON.parse(localStorage.getItem('workNotes') || '[]');
            localStorage.setItem('workNotes', JSON.stringify(notes.filter(n => n.id !== id)));
            displayNotes();
            showStatus('success', 'üóëÔ∏è ƒê√£ x√≥a');
        }

        // Export
        async function exportToPDF() {
            if (!window.exportService) return showStatus('error', '‚ùå Ch∆∞a s·∫µn s√†ng');
            
            showLoading();
            try {
                await exportService.exportToPDF({
                    emotions: JSON.parse(localStorage.getItem('emotionHistory') || '[]'),
                    notes: JSON.parse(localStorage.getItem('workNotes') || '[]'),
                    stats: {
                        workTime: document.getElementById('workTime').textContent,
                        tasksCompleted: document.getElementById('tasksCompleted').textContent,
                        productivity: document.getElementById('productivity').textContent
                    }
                });
                showStatus('success', '‚úÖ ƒê√£ xu·∫•t PDF!');
            } catch (err) {
                showStatus('error', '‚ùå L·ªói: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        async function exportToCSV() {
            if (!window.exportService) return showStatus('error', '‚ùå Ch∆∞a s·∫µn s√†ng');
            
            showLoading();
            try {
                await exportService.exportToCSV(
                    JSON.parse(localStorage.getItem('emotionHistory') || '[]')
                );
                showStatus('success', '‚úÖ ƒê√£ xu·∫•t CSV!');
            } catch (err) {
                showStatus('error', '‚ùå L·ªói: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        // Settings
        function saveSettings() {
            localStorage.setItem('appSettings', JSON.stringify({
                notificationsEnabled: document.getElementById('notificationsEnabled').checked,
                detectionInterval: document.getElementById('detectionInterval').value,
                confidenceThreshold: document.getElementById('confidenceThreshold').value
            }));
            showStatus('success', '‚úÖ ƒê√£ l∆∞u');
        }

        function resetSettings() {
            localStorage.removeItem('appSettings');
            document.getElementById('notificationsEnabled').checked = true;
            document.getElementById('detectionInterval').value = 1000;
            document.getElementById('confidenceThreshold').value = 60;
            document.getElementById('confidenceValue').textContent = '60%';
            showStatus('success', 'üîÑ ƒê√£ reset');
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('appSettings') || 'null');
            if (!settings) return;
            
            if (settings.notificationsEnabled !== undefined)
                document.getElementById('notificationsEnabled').checked = settings.notificationsEnabled;
            if (settings.detectionInterval)
                document.getElementById('detectionInterval').value = settings.detectionInterval;
            if (settings.confidenceThreshold) {
                document.getElementById('confidenceThreshold').value = settings.confidenceThreshold;
                document.getElementById('confidenceValue').textContent = settings.confidenceThreshold + '%';
            }
        }

        document.getElementById('confidenceThreshold').addEventListener('input', (e) => {
            document.getElementById('confidenceValue').textContent = e.target.value + '%';
        });

        // Charts
        function initializeCharts() {
            if (typeof Chart === 'undefined') return console.warn('Chart.js not loaded');

            const ctx1 = document.getElementById('emotionChart').getContext('2d');
            charts.emotion = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Happy', 'Sad', 'Angry', 'Surprised', 'Neutral', 'Fearful', 'Disgusted'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#6366f1', '#ec4899', '#14b8a6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            const ctx2 = document.getElementById('productivityChart').getContext('2d');
            charts.productivity = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'NƒÉng su·∫•t (%)',
                        data: [],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });

            const ctx3 = document.getElementById('emotionHistoryChart').getContext('2d');
            charts.emotionHistory = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'S·ªë l·∫ßn xu·∫•t hi·ªán',
                        data: [],
                        backgroundColor: '#6366f1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function updateCharts() {
            if (!charts.emotion) return;

            const history = JSON.parse(localStorage.getItem('emotionHistory') || '[]');
            if (history.length === 0) return;

            const counts = {};
            history.forEach(item => {
                counts[item.emotion] = (counts[item.emotion] || 0) + 1;
            });

            charts.emotion.data.datasets[0].data = [
                counts['happy'] || 0, counts['sad'] || 0, counts['angry'] || 0,
                counts['surprised'] || 0, counts['neutral'] || 0,
                counts['fearful'] || 0, counts['disgusted'] || 0
            ];
            charts.emotion.update();

            const last24 = history.slice(-24);
            charts.productivity.data.labels = last24.map((_, i) => i + 1);
            charts.productivity.data.datasets[0].data = last24.map(item => item.focusScore || 50);
            charts.productivity.update();

            charts.emotionHistory.data.labels = Object.keys(counts);
            charts.emotionHistory.data.datasets[0].data = Object.values(counts);
            charts.emotionHistory.update();
        }

        // UI Helpers
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showStatus(type, message) {
            const div = document.getElementById('statusMessage');
            div.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => div.innerHTML = '', 5000);
        }
    </script>
</body>
</html>
